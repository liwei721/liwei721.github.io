<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="平时工作和生活中的感悟记录">
<meta property="og:type" content="website">
<meta property="og:title" content="利伟的技术博客">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="利伟的技术博客">
<meta property="og:description" content="平时工作和生活中的感悟记录">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="利伟的技术博客">
<meta name="twitter:description" content="平时工作和生活中的感悟记录">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title> 利伟的技术博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">利伟的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">分享、交流、成长</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/08/初始build-gradle-gradle系列二/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liwei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="利伟的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/08/初始build-gradle-gradle系列二/" itemprop="url">
                  初始build.gradle(gradle系列二)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-08T10:38:01+08:00">
                2017-03-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/gradle/" itemprop="url" rel="index">
                    <span itemprop="name">gradle</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/08/初始build-gradle-gradle系列二/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/08/初始build-gradle-gradle系列二/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="理解Gradle脚本"><a href="#理解Gradle脚本" class="headerlink" title="理解Gradle脚本"></a>理解Gradle脚本</h2><ul>
<li>当你新建一个AndroidStudio 工程时，会默认的创建三个gradle文件，一个setting.gradle, 两个build.gradle，他们的文件结构如下：<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">MyApp</div><div class="line">  ├── build.gradle</div><div class="line">  ├── settings.gradle</div><div class="line">  └── app</div><div class="line">      └── build.gradle</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="setting-gradle"><a href="#setting-gradle" class="headerlink" title="setting.gradle"></a>setting.gradle</h3><ul>
<li><p>当你的app只有一个模块的时候，你的setting.gradle是这个样子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">include <span class="string">':app'</span></div></pre></td></tr></table></figure>
</li>
<li><p>setting.gradle 文件将会在初始化时期执行，它定义了哪个模块会被构建，比如上面app模块会被构建。setting.gradle 是针对多模块操作的，所以单独的模块工程可以删除掉该文件。初始化后，Gradle会为我们创建一个Setting对象，并为其包含必要的方法。</p>
</li>
</ul>
<h3 id="根目录的build-gradle"><a href="#根目录的build-gradle" class="headerlink" title="根目录的build.gradle"></a>根目录的build.gradle</h3><ul>
<li><p>该gradle文件是定义在这个工程下的所有模块的公共属性，它默认包含二个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">buildscript &#123;</div><div class="line">     repositories &#123;</div><div class="line">         jcenter()</div><div class="line">     &#125;</div><div class="line">      dependencies &#123;</div><div class="line">          classpath <span class="string">'com.android.tools.build:gradle:1.2.3'</span></div><div class="line">      &#125;</div><div class="line">&#125;</div><div class="line">allprojects &#123;</div><div class="line">     repositories &#123;</div><div class="line">          jcenter()</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>buildscript方法是定义了全局的相关属性，repositories定义了jcenter作为仓库，一个仓库代表着你依赖包的来源。</p>
</li>
<li>dependencies用来定义构建过程，你只需要定义默认的Android插件就可以了，因为该插件可以让你执行相关的Android的tasks。</li>
<li>allprojects方法可以用来定义各个模块的默认属性，你可以不仅仅局限于默认的配置，你可以自己创建tasks在allprojects方法体内，这些tasks将会在所有模块中可见。</li>
</ul>
<h3 id="模块内的build-gradle"><a href="#模块内的build-gradle" class="headerlink" title="模块内的build.gradle"></a>模块内的build.gradle</h3><ul>
<li><p>模块内的gradle文件只对该模块起作用，而且其可以重写任何来自于根目录gradle文件的参数，该模块文件如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'com.android.application'</span></div><div class="line">   android &#123;</div><div class="line">       compileSdkVersion <span class="number">22</span></div><div class="line">       buildToolsVersion <span class="string">"22.0.1"</span></div><div class="line">       defaultConfig &#123;</div><div class="line">           applicationId <span class="string">"com.gradleforandroid.gettingstarted"</span></div><div class="line">           minSdkVersion <span class="number">14</span></div><div class="line">           targetSdkVersion <span class="number">22</span></div><div class="line">           versionCode <span class="number">1</span></div><div class="line">           versionName <span class="string">"1.0"</span></div><div class="line">       &#125;</div><div class="line">       buildTypes &#123;</div><div class="line">           release &#123;</div><div class="line">               <span class="function">minifyEnabled <span class="keyword">false</span></span></div><div class="line">               proguardFiles <span class="title">getDefaultProguardFile</span></div><div class="line">                <span class="params">(<span class="string">'proguard-android.txt'</span>)</span>, 'proguard-rules.pro'</div><div class="line">           &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    dependencies &#123;</div><div class="line">       <span class="function">compile <span class="title">fileTree</span><span class="params">(dir: <span class="string">'libs'</span>, include: [<span class="string">'*.jar'</span>])</span></span></div><div class="line">       compile 'com.android.support:appcompat-v7:22.2.0'</div><div class="line">     &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>第一行是Android应用插件，是Google的Android开发团队编写的插件，可以提供所有Android应用和依赖库的构建，打包和测试。</p>
</li>
<li>android括号包含了Android属性，而唯一必须的属性是：compileSdkVersion （编译app时使用的api版本）和 buildToolsVersion（Android构建工具的版本号），其中构建工具包含了很多使用的命令行命令，比如：aapt、zipalign、dx等。</li>
<li><p>defaultConfig方法包含了该app的核心属性，该属性会重写AndroidMainfest.xml中的对应属性。</p>
<blockquote>
<ol>
<li>applicationId ,该属性复写了AndroidManifest.xml文件中的包名packageName</li>
<li>minSdkVersion和targetSDKVersion，这两个和AndroidManifes中的<uses-sdk>很像。</uses-sdk></li>
<li>versionCode 将作为版本号标示，而versionName没有作用。</li>
</ol>
</blockquote>
</li>
<li><p>buildTypes 方法定义了如何构建不同版本的app。</p>
</li>
<li>dependencies 为app定义了所有的依赖包，默认情况下，会依赖所有libs文件下的jar文件，同时包含了AppCompat这个aar文件。</li>
</ul>
<h2 id="理解tasks"><a href="#理解tasks" class="headerlink" title="理解tasks"></a>理解tasks</h2><ul>
<li>如果你想知道你有多少tasks可以用，直接运行gradlew tasks，其会为你展示所有可用的tasks，当你创建一个Android工程，那么将包含Android tasks、build tasks、build setup tasks、help tasks、install tasks、verification tasks等。</li>
</ul>
<h3 id="基本的tasks"><a href="#基本的tasks" class="headerlink" title="基本的tasks"></a>基本的tasks</h3><ul>
<li>Android插件依赖于java插件，而java插件依赖于base插件。</li>
<li>base插件有基本的tasks生命周期和一些通用的属性。</li>
<li><p>base插件定义了例如assemble和clean任务，java插件定义了check和build任务，这两个任务不在base插件中定义。这些tasks的含义：</p>
<blockquote>
<ol>
<li>assemble 集合所有的output</li>
<li>clean   清除所有的output</li>
<li>check   执行所有的checks检查，通常是unit测试和instrumentation测试。</li>
<li>build   执行所有的assemble和check</li>
</ol>
</blockquote>
</li>
<li><p>java插件同时也添加了source sets的概念。</p>
</li>
</ul>
<h3 id="Android-tasks"><a href="#Android-tasks" class="headerlink" title="Android tasks"></a>Android tasks</h3><ul>
<li><p>Android插件继承了这些基本tasks并且实现了它自己的行为：</p>
<blockquote>
<ol>
<li>assemble 针对每个版本创建一个apk</li>
<li>clean    删除所有的构建任务，包含apk文件。</li>
<li>check    执行lint检查并且能够在lint检查到错误后停止执行脚本。</li>
<li>build    执行assemble和check</li>
</ol>
</blockquote>
</li>
<li><p>默认情况下assemble tasks定义了assembleDebug和assembleRelease，当然你还可以定义更多的构建版本，除了这些tasks，Android插件也提供了一些新的tasks：</p>
<blockquote>
<ol>
<li>connectedCheck 在测试机上面执行所有测试任务。</li>
<li>deviceCheck     执行所有的测试在远程设备上。</li>
<li>installDebug 和 installRelease 在设备安装一个特殊的版本。</li>
<li>所有的install task 对应有uninstall 任务。</li>
</ol>
</blockquote>
</li>
<li><p>build task依赖于check任务，但是不依赖于connectedCheck或者deviceCheck，执行check任务的使用的lint会产生一些相关文件，这些报告可以在/app/build/outputs/中查看。</p>
</li>
</ul>
<h3 id="BuildConfig-amp-resources"><a href="#BuildConfig-amp-resources" class="headerlink" title="BuildConfig &amp; resources"></a>BuildConfig &amp; resources</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    buildTypes &#123;</div><div class="line">        debug &#123;</div><div class="line">            buildConfigField <span class="string">"String"</span>, <span class="string">"API_URL"</span>,</div><div class="line">               <span class="string">"\"http://test.example.com/api\""</span></div><div class="line">            buildConfigField <span class="string">"boolean"</span>, <span class="string">"LOG_HTTP_CALLS"</span>, <span class="string">"true"</span></div><div class="line">     &#125;</div><div class="line">       release &#123;</div><div class="line">            buildConfigField <span class="string">"String"</span>, <span class="string">"API_URL"</span>,</div><div class="line">                <span class="string">"\"http://example.com/api\""</span></div><div class="line">            buildConfigField <span class="string">"boolean"</span>, <span class="string">"LOG_HTTP_CALLS"</span>,<span class="string">"false"</span></div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<ul>
<li>这样定义的常量，可以在代码中使用BuildConfig.API_URL和BuildConfig.LOG_HTTP</li>
</ul>
<h3 id="全局设置"><a href="#全局设置" class="headerlink" title="全局设置"></a>全局设置</h3><ul>
<li><p>如果你有很多模块在一个工程下，你可以这么定义你的project文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">allprojects &#123;</div><div class="line">       apply plugin: <span class="string">'com.android.application'</span></div><div class="line">       android &#123;</div><div class="line">           compileSdkVersion <span class="number">22</span></div><div class="line">           buildToolsVersion <span class="string">"22.0.1"</span></div><div class="line">       &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>这样只有你的模块是Android app应用的时候有效，你需要添加Android插件才能访问Android的tasks，更好的做法是在你全局的gradle文件中定义一些属性，然后在模块中运用他们，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ext &#123;</div><div class="line">      compileSdkVersion = <span class="number">22</span></div><div class="line">      buildToolsVersion = <span class="string">"22.0.1"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>这样你在子模块中就可以使用这些属性了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">       compileSdkVersion rootProject.ext.compileSdkVersion</div><div class="line">       buildToolsVersion rootProject.ext.buildToolsVersion</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<h3 id="Project-properties"><a href="#Project-properties" class="headerlink" title="Project properties"></a>Project properties</h3><ul>
<li><p>上面提到的ext只是一种办法，还有其他方法，比如：gradle properties 、-p参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">ext &#123;</div><div class="line">     local = <span class="string">'Hello from build.gradle'</span></div><div class="line">&#125;</div><div class="line">   task printProperties &lt;&lt; &#123;</div><div class="line">     println local        <span class="comment">// Local extra property</span></div><div class="line">     println propertiesFile        <span class="comment">// Property from file</span></div><div class="line">     <span class="keyword">if</span> (project.hasProperty(<span class="string">'cmd'</span>)) &#123;</div><div class="line">       println cmd        <span class="comment">// Command line property</span></div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>在gradle.properties中定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">propertiesFile = Hello from gradle.properties</div></pre></td></tr></table></figure>
</li>
<li><p>这样在命令行执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ gradlew <span class="built_in">print</span>Properties -P cmd=<span class="string">'Hello from the command line'</span></div><div class="line">:<span class="built_in">print</span>Properties</div><div class="line">Hello from build.gradle</div><div class="line">Hello from gradle.properties</div><div class="line">Hello from the <span class="built_in">command</span> line</div></pre></td></tr></table></figure>
</li>
<li><p>上面就是三种定义gradle属性的方法。可以根据自己的需求来选择使用哪种方式。</p>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/07/初识gradle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liwei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="利伟的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/07/初识gradle/" itemprop="url">
                  初识gradle（gradle系列一）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-07T18:20:18+08:00">
                2017-03-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/gradle/" itemprop="url" rel="index">
                    <span itemprop="name">gradle</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/07/初识gradle/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/07/初识gradle/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><ul>
<li>大家对Ant和Maven一定不陌生，Ant是2000年发布，它基于程序编程思想的发展，但它主要缺点是使用XML作为一种格式来写构建脚本，XML是分层的，不利于程序的编程，而且当XML文件变大之后维护变的困难。</li>
<li>Maven在2004年推出，比Ant有很大的改进，它改变了结构并且继续使用XML编写生成规范，它的依赖约定能通过网络下载依赖关系（这是特点）。但它的缺点是它不会处理同一库版本之间的冲突，另外复杂的定制构建脚本实际上比Ant更加难写。</li>
<li>Gradle于2012年发布，是一个基于Ant和Maven概念的项目自动化构建工具，它使用一种基于Groovy的特定领域语言（DSL）来声明项目配置，抛弃了繁琐的XML配置。它面向java应用为主，当前支持的语言：java、Groovy、Scala，未来可能会支持更多的语言。</li>
<li>Groovy语言是一种基于JVM的动态语言。</li>
</ul>
<h3 id="gradle的功能特点"><a href="#gradle的功能特点" class="headerlink" title="gradle的功能特点"></a>gradle的功能特点</h3><ul>
<li><p>声明式构建和合约构建</p>
<blockquote>
<ol>
<li>Gradle通过提供随意集成的声明式语言将声明语言推到一个新高度，这些元素也为java、Groovy、OSGI、Web和Scala等项目提供基于合约构建的支持，扩展性很好。</li>
</ol>
</blockquote>
</li>
<li><p>基于依赖的编程语言</p>
</li>
<li>让构建结构化</li>
<li>API深化</li>
<li>gradle扩展</li>
<li>多项目构建</li>
<li><p>多种方式来管理依赖</p>
<blockquote>
<ol>
<li>从远程的maven和ivy库的依赖管理到本地文件系统的jars或者dirs都支持。</li>
</ol>
</blockquote>
</li>
<li><p>Gradle是第一个构建整合工具</p>
<blockquote>
<ol>
<li>它整合了Ant和Maven的一些特点和概念。</li>
</ol>
</blockquote>
</li>
<li><p>易于迁移</p>
</li>
<li>基于Groovy编写。</li>
<li><p>Gradle包装器</p>
<blockquote>
<ol>
<li>gradle包装器允许你在没有安装Gradle的机器上运行Gradle构建。这非常方便，可以降低使用项目的门槛。</li>
</ol>
</blockquote>
</li>
<li><p>免费和开源</p>
</li>
</ul>
<h2 id="安装Gradle"><a href="#安装Gradle" class="headerlink" title="安装Gradle"></a>安装Gradle</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><ul>
<li>gradle运行在一个java环境里。因此需要安装java环境，且版本需要在6以上。</li>
</ul>
<h3 id="下载与安装"><a href="#下载与安装" class="headerlink" title="下载与安装"></a>下载与安装</h3><ul>
<li>从<a href="https://gradle.org/install" target="_blank" rel="external">gradle网站</a>下载gradle zip文件。注意gradle的版本，最新的应该是3.x了。</li>
<li>解压缩之后，将gradle配置到环境变量中（GRADLE_HOME=解压根目录，GRADLE_HOME\bin配置到PATH路径中）</li>
<li>配置完成后，打开cmd命令行，输入gradle -v验证配置是否成功。<br><img src="/upload/image/zlw/gradleV.PNG" alt="gradle配置"></li>
</ul>
<h3 id="JVM选项"><a href="#JVM选项" class="headerlink" title="JVM选项"></a>JVM选项</h3><ul>
<li>JAVA_OPTS是一个用于JAVA应用的环境变量，一个典型的用例是在JAVA_OPTS里设置HTTP代理服务器（proxy）</li>
<li>GRADLE_OPTS是内存选项，这些变量可以在gradle开始设置或者通过Gradlew脚本来设置。</li>
</ul>
<h2 id="gradle概念"><a href="#gradle概念" class="headerlink" title="gradle概念"></a>gradle概念</h2><h3 id="Project-amp-amp-tasks"><a href="#Project-amp-amp-tasks" class="headerlink" title="Project &amp;&amp; tasks"></a>Project &amp;&amp; tasks</h3><ul>
<li>在gradle中有两个重要的概念，分别是project和tasks。每一次构建都是有至少一个project来完成，所以AndroidStudio中的project和Gradle中的project不是一个概念。每个project有至少一个tasks，每一个build.gradle文件代表一个gradle，tasks在build.gradle中定义，当初始化构建进程，gradle会基于build文件，集合所有的project和tasks，一个task包含了一系列动作，然后他们将会按照顺序执行，一个动作就是一段被执行的代码，很像java中的方法。</li>
</ul>
<h3 id="构建的生命周期"><a href="#构建的生命周期" class="headerlink" title="构建的生命周期"></a>构建的生命周期</h3><p>一旦一个task被执行，那么它不会再次执行了，不包含依赖的tasks总是优先执行，一次构建会经历下面三个阶段：</p>
<ul>
<li>初始化阶段：project实例在这儿创建，如果有多个模块，即有多个build.gradle文件，多个project将会被创建。</li>
<li>配置阶段：在该阶段，build.gradle脚本将会执行，为每个project创建和配置所有的tasks。</li>
<li>执行阶段：这一阶段，gradle会决定哪一个tasks会被执行，哪一个tasks会被完全依赖开始构建时传入的参数和当前所在的文件夹位置有关。</li>
</ul>
<h3 id="build-gradle的配置文件"><a href="#build-gradle的配置文件" class="headerlink" title="build.gradle的配置文件"></a>build.gradle的配置文件</h3><ul>
<li><p>我们来看看Android的build.gradle</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">buildscript &#123;</div><div class="line">   repositories &#123;</div><div class="line">        jcenter()</div><div class="line">   &#125;</div><div class="line">   dependencies &#123;</div><div class="line">       classpath <span class="string">'com.android.tools.build:gradle:1.2.3'</span></div><div class="line"> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>这个是构建实际开始的地方，在仓库地址中使用了jcenter , jcenter 类似于Maven库，不需要任何额外的配置，gradle还支持其他几个仓库，不论是远程还是本地仓库。</p>
</li>
</ul>
<h3 id="Gradle-Wrapper"><a href="#Gradle-Wrapper" class="headerlink" title="Gradle Wrapper"></a>Gradle Wrapper</h3><ul>
<li><p>gradle只是一个构建工具，而新版本总是在更迭，所以使用Gradle Wrapper将会是一个好的选择去避免由于gradle版本更新导致的问题，Gradle Wrapper提供了一个windows的batch文件和其他系统的shell文件，当你使用这些脚本的时候，当前gradle版本将会被下载，并且会自动运行到项目构建。windows上运行gradlew.bat, mac上运行gradlew。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">myapp/</div><div class="line">  ├── gradlew</div><div class="line">  ├── gradlew.bat</div><div class="line">  └── gradle/wrapper/</div><div class="line">      ├── gradle-wrapper.jar</div><div class="line">      └── gradle-wrapper.properties</div></pre></td></tr></table></figure>
</li>
<li><p>配置文件的内容如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#Sat May 30 17:41:49 CEST 2015</div><div class="line">   distributionBase=GRADLE_USER_HOME</div><div class="line">   distributionPath=wrapper/dists</div><div class="line">   zipStoreBase=GRADLE_USER_HOME</div><div class="line">   zipStorePath=wrapper/dists</div><div class="line">   distributionUrl=https\://services.gradle.org/distributions/</div><div class="line">   gradle-2.4-all.zip</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="使用基本的构建命令"><a href="#使用基本的构建命令" class="headerlink" title="使用基本的构建命令"></a>使用基本的构建命令</h3><ul>
<li><p>查看可以运行的tasks</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ gradlew tasks （--all）    加上-all参数来查看所有的task</div></pre></td></tr></table></figure>
</li>
<li><p>构建项目</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ gradlew assembleDebug   构建一个debug版本的app</div><div class="line">除了assemble，还有三个基本命令：</div><div class="line">1. check运行所有的checks，换句话说是运行所有的tests在已连接的设备或者模拟器上。</div><div class="line">2. build 是check和assemble的集合体。</div><div class="line">3. clean 是清除项目的outputs文件。</div></pre></td></tr></table></figure>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/02/java代码优化建议（持续更新）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liwei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="利伟的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/02/java代码优化建议（持续更新）/" itemprop="url">
                  java代码优化建议（持续更新）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-02T16:47:37+08:00">
                2017-03-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java知识/" itemprop="url" rel="index">
                    <span itemprop="name">java知识</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/02/java代码优化建议（持续更新）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/02/java代码优化建议（持续更新）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><ul>
<li>最近做静态代码扫描过程中，收集了一些开发经常使用，但是可以优化的代码，整理出来，供大家参考和交流。</li>
<li>使用的静态代码扫描工具：findbugs、360火线。</li>
</ul>
<h2 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h2><h3 id="Integer-valueOf-“XXXXX”"><a href="#Integer-valueOf-“XXXXX”" class="headerlink" title="Integer.valueOf(“XXXXX”)"></a>Integer.valueOf(“XXXXX”)</h3><ul>
<li>这种写法主要会影响代码性能，建议使用Integer.parseInt(“XXXX”)</li>
<li>通过阅读源码我们可以知道，Integer.valueOf(“a”) 当a在[-128, 128]之间时本地有缓存返回int类型，但是不在这个区间，比如大于128时，会new Integer(a)返回。而Integer.paseInt(“a”) 始终返回的是int类型。</li>
<li>所以Integer.valueOf(“XXXXX”)这种写法，会多了一次从int到Integer（自动装箱）和 从Integer到int（自动拆箱）的过程，从而影响效率。</li>
</ul>
<h3 id="循环中使用-来拼接String"><a href="#循环中使用-来拼接String" class="headerlink" title="循环中使用 + 来拼接String"></a>循环中使用 + 来拼接String</h3><ul>
<li>这种写法对性能影响很大。用 加号 拼接String，比较方便，所以很多人习惯性的就这么用。</li>
<li>以 cc = “aa” + “bb”为例，编译器在处理时会 cc = new StringBuffer(“aa”).append(“bb”).toString()。</li>
<li>这明显有两个影响效率的方面：1. 每次会 new 一个对象，（循环中会增加内存碎片）  2. 每次还要调用toString 转成字符串。 如果在循环中这么用，对性能影响是相当大的。</li>
</ul>
<h3 id="stream-amp-amp-resource-忘记关闭"><a href="#stream-amp-amp-resource-忘记关闭" class="headerlink" title="stream &amp;&amp; resource 忘记关闭"></a>stream &amp;&amp; resource 忘记关闭</h3><ul>
<li>这个问题是老生常谈的问题。但是findbugs还是扫出来很多没有close的stream。</li>
<li>不关闭资源会造成资源浪费，并且可能造成内存泄漏。</li>
<li>建议写这类代码时，只要new 出来一个资源，就立即在finally中去close资源，防止逻辑写多了，忘记close。</li>
</ul>
<h3 id="对空指针考虑不充分"><a href="#对空指针考虑不充分" class="headerlink" title="对空指针考虑不充分"></a>对空指针考虑不充分</h3><ul>
<li>这个问题可能在某些场景下出现，直接造成程序崩溃。下面就直接贴几段代码<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">SyncPowerData syncPowerData = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">        syncPowerData = apiFactory.getAccountApi().getSyncPowerRequest(map).execute().body();</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> code = syncPowerData.getCode();</div></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">FileChannel in = <span class="keyword">null</span>;</div><div class="line">FileChannel out = <span class="keyword">null</span>;</div><div class="line">FileInputStream inStream = <span class="keyword">null</span>;</div><div class="line">FileOutputStream outStream = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    inStream = <span class="keyword">new</span> FileInputStream(srcFile);</div><div class="line">    outStream = <span class="keyword">new</span> FileOutputStream(destFile);</div><div class="line">    in = inStream.getChannel();</div><div class="line">    out = outStream.getChannel();</div><div class="line">    in.transferTo(<span class="number">0</span>, in.size(), out);</div><div class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">    LogUtil.getUtils().e(<span class="string">"copyFile failed when copy data"</span> + e.getMessage(),e);</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> FileIOException(FileIOException.ERROR_COPY_FILE);</div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        inStream.close();</div><div class="line">        in.close();</div><div class="line">        outStream.close();</div><div class="line">        out.close();</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div></pre></td></tr></table></figure>
<ul>
<li>上面两个例子其实类似，当有异常发生，造成对象没有初始化成功时，那么再使用对象就会抛出nullpointerException。</li>
<li>所以要养成良好的编程习惯，在可能出现null的地方判null。增加程序的健壮性</li>
</ul>
<h3 id="单例模式写法不规范"><a href="#单例模式写法不规范" class="headerlink" title="单例模式写法不规范"></a>单例模式写法不规范</h3><ul>
<li>这个问题主要在多线程情况下会产生影响，可能多个线程调用返回的是不同的对象，从而失去了单例的意义。</li>
<li><p>建议使用双重校验锁模式，代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span></span>&#123;  </div><div class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> Singleton single;    <span class="comment">//声明静态的单例对象的变量  </span></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span></span>&#123;&#125;    <span class="comment">//私有构造方法   </span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getSingle</span><span class="params">()</span></span>&#123;    <span class="comment">//外部通过此方法可以获取对象    </span></div><div class="line">    <span class="keyword">if</span>(single == <span class="keyword">null</span>)&#123;     </div><div class="line">        <span class="keyword">synchronized</span> (Singleton.class) &#123;   <span class="comment">//保证了同一时间只能只能有一个对象访问此同步块        </span></div><div class="line">            <span class="keyword">if</span>(single == <span class="keyword">null</span>)&#123;      </div><div class="line">                single = <span class="keyword">new</span> Singleton();          </div><div class="line">        &#125;     </div><div class="line">      &#125;  </div><div class="line">    &#125;    </div><div class="line">    <span class="keyword">return</span> single;   <span class="comment">//返回创建好的对象   </span></div><div class="line">  &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>注意这种方法一定要加volatile，主要在于instance = new Singleton()这句，这并非是一个原子操作，事实上在 JVM 中这句话大概做了下面 3 件事情:</p>
<blockquote>
<ul>
<li>给 instance 分配内存</li>
<li>调用 Singleton 的构造函数来初始化成员变量</li>
<li>将instance对象指向分配的内存空间（执行完这步 instance 就为非 null 了）</li>
<li>但是在 JVM 的即时编译器中存在指令重排序的优化。也就是说上面的第二步和第三步的顺序是不能保证的，最终的执行顺序可能是 1-2-3 也可能是 1-3-2。如果是后者，则在 3 执行完毕、2 未执行之前，被线程二抢占了，这时 instance 已经是非 null 了（但却没有初始化），所以线程二会直接返回 instance，然后使用，然后顺理成章地报错。</li>
</ul>
</blockquote>
</li>
<li><p>加volatile最主要的作用是禁止指令重排。关于指令重排的知识，大家可以网上查资料<a href="http://wuchong.me/blog/2014/08/28/how-to-correctly-write-singleton-pattern/" target="_blank" rel="external">单例详细介绍</a></p>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/02/代码覆盖工具jacoco的介绍和使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liwei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="利伟的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/02/代码覆盖工具jacoco的介绍和使用/" itemprop="url">
                  浅谈代码覆盖率
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-02T11:22:25+08:00">
                2017-03-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/测试工具/" itemprop="url" rel="index">
                    <span itemprop="name">测试工具</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/02/代码覆盖工具jacoco的介绍和使用/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/02/代码覆盖工具jacoco的介绍和使用/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><ul>
<li>我们平时写自动化，或者功能测试，最理想的状态是测完之后能自信的告诉开发，我们测试没问题了，可以发布了。</li>
<li>代码覆盖率就是这样一个工具，可以帮助我们了解我们的测试现状，对源代码的覆盖程度。</li>
<li>但是需要明确代码覆盖率本身对 产品质量 是没有意义的。并不能说覆盖率高，产品质量就高。<br><img src="/upload/image/zlw/代码覆盖率.png" alt="代码覆盖率"></li>
</ul>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="代码覆盖率"><a href="#代码覆盖率" class="headerlink" title="代码覆盖率"></a>代码覆盖率</h3><ul>
<li>代码覆盖率我的理解是一种度量方式，用来度量测试代码对源码逻辑的覆盖程度。作为对测试用例的一个补充、衡量和完善。</li>
</ul>
<h3 id="代码覆盖率统计方式"><a href="#代码覆盖率统计方式" class="headerlink" title="代码覆盖率统计方式"></a>代码覆盖率统计方式</h3><ul>
<li>行覆盖率：度量被测程序的每行代码是否被执行，判断标准行中是否至少有一个指令被执行。</li>
<li>类覆盖率：度量计算class类文件是否被执行。</li>
<li>分支覆盖率：度量if和switch语句的分支覆盖情况，计算一个方法里面的总分支数，确定执行和不执行的 分支数量。</li>
<li>方法覆盖率：度量被测程序的方法执行情况，是否执行取决于方法中是否有至少一个指令被执行。</li>
<li>圈复杂度：又称断言覆盖(PredicateCoverage)。它度量了是否函数的每一个分支都被执行了。 这句话也非常好理解，就是所有可能的分支都执行一遍，有多个分支嵌套时，需要对多个分支进行排列组合，可想而知，测试路径随着分支的数量指数级别增加。</li>
<li>关于这几种代码覆盖率方式详细介绍<a href="http://www.cnblogs.com/coderzh/archive/2009/03/29/1424344.html" target="_blank" rel="external">请点我</a>，这篇文章中介绍了代码覆盖率的概念、策略使用优先级以及对使用代码覆盖率的建议，可以认真看看。</li>
</ul>
<h3 id="代码覆盖率意义"><a href="#代码覆盖率意义" class="headerlink" title="代码覆盖率意义"></a>代码覆盖率意义</h3><ul>
<li>分析未覆盖部分的代码，从而反推在前期测试设计是否充分，没有覆盖到的代码是否是测试设计的盲点，为什么没有考虑到？需求/设计不够清晰，测试设计的理解有误，工程方法应用后的造成的策略性放弃等等，之后进行补充测试用例设计。</li>
<li>检测出程序中的废代码，可以逆向反推在代码设计中思维混乱点，提醒设计/开发人员理清代码逻辑关系，提升代码质量。</li>
<li>代码覆盖率高不能说明代码质量高，但是反过来看，代码覆盖率低，代码质量不会高到哪里去，可以作为测试自我审视的重要工具之一。</li>
</ul>
<h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><ul>
<li>主流的测试工具有Jacoco、Emma，这俩工具是同一个团队做的，不过Emma已经不再维护了。下图是常用工具的一些对比：<br><img src="/upload/image/zlw/codeConvery.png" alt="代码覆盖率"></li>
<li>由于jacoco的优点，推荐使用jacoco做代码覆盖率检查。下面我们花点时间介绍下Jacoco。</li>
</ul>
<h3 id="Jacoco简介"><a href="#Jacoco简介" class="headerlink" title="Jacoco简介"></a>Jacoco简介</h3><ul>
<li>JaCoCo是一个开源的覆盖率工具(官网地址：<a href="http://www.eclemma.org/JaCoCo/)，它针对的开发语言是java，其使用方法很灵活，可以嵌入到Ant、Maven中；可以作为Eclipse插件，可以使用其JavaAgent技术监控Java程序等等。" target="_blank" rel="external">http://www.eclemma.org/JaCoCo/)，它针对的开发语言是java，其使用方法很灵活，可以嵌入到Ant、Maven中；可以作为Eclipse插件，可以使用其JavaAgent技术监控Java程序等等。</a></li>
<li>此外JaCoCo还可以集成到Jenkins中做持续集成。</li>
</ul>
<h3 id="Jacoco等工具的工作原理"><a href="#Jacoco等工具的工作原理" class="headerlink" title="Jacoco等工具的工作原理"></a>Jacoco等工具的工作原理</h3><p><img src="/upload/image/zlw/覆盖率工具工作流程.png" alt="工作原理"></p>
<ol>
<li>对Java字节码进行插桩（插入用于统计信息的标志），On-The-Fly（需要使用agent代理）和Offine（需要源码，测试之前插桩）两种方式。</li>
<li>执行测试用例，收集程序执行轨迹信息，将其dump到内存。</li>
<li>数据处理器结合程序执行轨迹信息和代码结构信息分析生成代码覆盖率报告。</li>
<li>将代码覆盖率报告图形化展示出来，如html、xml等文件格式。</li>
</ol>
<h3 id="JaCoCo插桩原理"><a href="#JaCoCo插桩原理" class="headerlink" title="JaCoCo插桩原理"></a>JaCoCo插桩原理</h3><p><img src="/upload/image/zlw/插桩原理.jpg" alt="插桩原理"></p>
<ul>
<li>这个图包含了几种不同的收集覆盖率信息的方法，每种方法的实现方法都不一样，带颜色的部分是JaCoCo比较有特色的地方。</li>
<li>主流代码覆盖率工具都采用字节码插桩模式，通过钩子的方式来记录代码执行轨迹信息。其中字节码插桩又分为两种模式On-The-Fly和Offine。On-The-Fly模式优点在于无需修改源代码，通过代理或者ClassLoader装载类的时候，判断是否已经插入了用于计数的探针，没有则插入，因此它可以实时获取覆盖率。Offline对应的优点是不需要开启对应的代理程序或者自定义ClassLoader，它需要程序运行完成之后</li>
</ul>
<h4 id="On-The-Fly"><a href="#On-The-Fly" class="headerlink" title="On-The-Fly"></a>On-The-Fly</h4><ul>
<li>On-the-Fly模式优点在于无需修改源代码，通过代理或者ClassLoader装载类的时候，判断是否已经插入了用于计数的探针，没有则插入，因此它可以实时获取覆盖率。</li>
</ul>
<h4 id="Offline"><a href="#Offline" class="headerlink" title="Offline"></a>Offline</h4><ul>
<li>Offline模式的优点是无需再额外的搞个代理程序或者自定义ClassLoader。</li>
<li>它需要在测试之前先对文件进行插桩，生成插过桩的class文件或者jar包，执行插过桩的class文件或者jar包之后，会生成覆盖率信息到文件，最后统一对覆盖率信息进行处理，并生成报告。</li>
<li><p>offline模式插桩又分为两种：</p>
<blockquote>
<ol>
<li>Replace:修改字节码生成新的class。</li>
<li>InJect: 在原有的class上面修改。</li>
</ol>
</blockquote>
</li>
<li><p>更详细的可以参考腾讯tmq写的系列文章<a href="http://tmq.qq.com/2016/08/java-code-coverage-tools-jacoco-principle/" target="_blank" rel="external">JAVA代码覆盖率工具JaCoCo-原理篇</a>,它里面详细介绍了根据代码逻辑type，怎么埋标记探针。当然也可以找源码看看，不过我也没看源码呢。</p>
</li>
</ul>
<h3 id="JaCoCo使用"><a href="#JaCoCo使用" class="headerlink" title="JaCoCo使用"></a>JaCoCo使用</h3><ul>
<li>JaCoco 提供了很多使用方式，比如：Ant、命令行、Maven、gradle、jenkins集成。</li>
<li>我比较关心的方式是（主要针对Android项目）：Jacoco和UI自动化结合、Jacoco和手动测试结合、Jacoco与Jenkins的集成。</li>
<li>其实gradle中android插件已经支持了jacoco的使用，因此我们只需要在app build.gradle中配置 jaCoco 以及在buildTypes中配置testCoverageEnabled=true,如下是我写的一个demo：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'com.android.application'</span></div><div class="line">apply plugin: <span class="string">'jacoco'</span></div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion <span class="number">25</span></div><div class="line">    buildToolsVersion <span class="string">"25.0.0"</span></div><div class="line">    defaultConfig &#123;</div><div class="line">        applicationId <span class="string">"xdja.com.dreamcode"</span></div><div class="line">        minSdkVersion <span class="number">15</span></div><div class="line">        targetSdkVersion <span class="number">25</span></div><div class="line">        versionCode <span class="number">1</span></div><div class="line">        versionName <span class="string">"1.0"</span></div><div class="line">        testInstrumentationRunner <span class="string">"android.support.test.runner.AndroidJUnitRunner"</span></div><div class="line">    &#125;</div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            <span class="function">minifyEnabled <span class="keyword">false</span></span></div><div class="line">            proguardFiles <span class="title">getDefaultProguardFile</span><span class="params">(<span class="string">'proguard-android.txt'</span>)</span>, 'proguard-rules.pro'</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        debug&#123;</div><div class="line">            <span class="function">proguardFiles <span class="title">getDefaultProguardFile</span><span class="params">(<span class="string">'proguard-android.txt'</span>)</span>, 'proguard-rules.pro'</span></div><div class="line">            zipAlignEnabled <span class="keyword">true</span></div><div class="line">            testCoverageEnabled = <span class="keyword">true</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">def coverageSourceDirs = [</div><div class="line">        <span class="string">'../app/src/main/java'</span></div><div class="line">]</div><div class="line"><span class="function">task <span class="title">jacocoTestReport</span><span class="params">(type: JacocoReport)</span> </span>&#123;</div><div class="line">    group = <span class="string">"Reporting"</span></div><div class="line">    description = <span class="string">"Generate Jacoco coverage reports after running tests."</span></div><div class="line">    reports &#123;</div><div class="line">        xml.enabled = <span class="keyword">true</span></div><div class="line">        html.enabled = <span class="keyword">true</span></div><div class="line">    &#125;</div><div class="line">    classDirectories = fileTree(</div><div class="line">            dir: <span class="string">'./build/intermediates/classes/debug'</span>,</div><div class="line">            excludes: [<span class="string">'**/R*.class'</span>,</div><div class="line">                       <span class="string">'**/*$InjectAdapter.class'</span>,</div><div class="line">                       <span class="string">'**/*$ModuleAdapter.class'</span>,</div><div class="line">                       <span class="string">'**/*$ViewInjector*.class'</span></div><div class="line">            ])</div><div class="line">    sourceDirectories = files(coverageSourceDirs)</div><div class="line">    executionData = files(<span class="string">"$buildDir/outputs/code-coverage/connected/coverage.ec"</span>)</div><div class="line"></div><div class="line">    doFirst &#123;</div><div class="line">        <span class="keyword">new</span> File(<span class="string">"$buildDir/intermediates/classes/"</span>).eachFileRecurse &#123; file -&gt;</div><div class="line">            <span class="keyword">if</span> (file.name.contains(<span class="string">'$$'</span>)) &#123;</div><div class="line">                file.renameTo(file.path.replace(<span class="string">'$$'</span>, <span class="string">'$'</span>))</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">dependencies &#123;</div><div class="line">    <span class="function">compile <span class="title">fileTree</span><span class="params">(dir: <span class="string">'libs'</span>, include: [<span class="string">'*.jar'</span>])</span></span></div><div class="line">    <span class="title">androidTestCompile</span><span class="params">(<span class="string">'com.android.support.test.espresso:espresso-core:2.2.2'</span>, &#123;</span></div><div class="line">        exclude group: <span class="string">'com.android.support'</span>, <span class="keyword">module</span>: <span class="string">'support-annotations'</span></div><div class="line">    &#125;)</div><div class="line">    compile 'com.android.support:appcompat-v7:25.0.1'</div><div class="line">    testCompile 'junit:junit:4.12'</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>上面jacocoTestReport 任务用于将采集的ec文件转成html文件。</li>
</ul>
<h3 id="Jacoco和手动测试结合"><a href="#Jacoco和手动测试结合" class="headerlink" title="Jacoco和手动测试结合"></a>Jacoco和手动测试结合</h3><ul>
<li>与手动结合测试，思路是通过反射，获取收集的覆盖率数据：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">out = <span class="keyword">new</span> FileOutputStream(mCoverageFilePath.getPath(), <span class="keyword">true</span>);</div><div class="line">            Object agent = Class.forName(<span class="string">"org.jacoco.agent.rt.RT"</span>)</div><div class="line">                    .getMethod(<span class="string">"getAgent"</span>)</div><div class="line">                    .invoke(<span class="keyword">null</span>);</div><div class="line">            out.write((<span class="keyword">byte</span>[]) agent.getClass().getMethod(<span class="string">"getExecutionData"</span>, <span class="keyword">boolean</span>.class)</div><div class="line">                    .invoke(agent, <span class="keyword">false</span>));</div></pre></td></tr></table></figure>
<ul>
<li>网上有人实现了一种方式是不修改源码的情况下，通过Instrumentation来启动个集成首页Activity的页面，然后当测试完成销毁页面的时候会去执行收集数据的代码。</li>
<li>不过实现方式上可以根据自己的需要来实现触发收集数据的场景，比如搞个广播、长按某个物理键等等。</li>
<li>生成的数据时ec格式，需要用到上面的jacocoTestReport task，转成html文件。生成的报告位于：.\app\build\reports\jacoco\jacocoTestReport目录</li>
</ul>
<h3 id="Jacoco和UI自动化结合"><a href="#Jacoco和UI自动化结合" class="headerlink" title="Jacoco和UI自动化结合"></a>Jacoco和UI自动化结合</h3><ul>
<li>首先需要了解gradle android plugin 一些内置的命令：</li>
</ul>
<table>
<thead>
<tr>
<th>列名</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>connectedAndroidTest</td>
<td>执行android的case</td>
</tr>
<tr>
<td>createDebugCoverageReport</td>
<td>产生代码覆盖率的报告</td>
</tr>
<tr>
<td>connectedCheck</td>
<td>包含上面2个任务</td>
</tr>
</tbody>
</table>
<ul>
<li>只需要将UI自动化代码准备好，然后执行：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ gradlew clean createDebugCoverageReport</div></pre></td></tr></table></figure>
<ul>
<li>这个命令会执行UI自动化代码，同时生成jaCoCo报告。</li>
<li>生成的JaCoCo报告位于：\app\build\reports\coverage（在reports目录下还有单元测试的结果报告）。</li>
<li>这里再介绍个手动测试收集代码覆盖率的思路： 在UI自动化中，执行一个sleep（比如停10分钟），这10分钟内可以手动操作测试业务，然后10分钟之后，UI自动化结束后会自动生成报告，可以参考<a href="https://testerhome.com/topics/2510" target="_blank" rel="external">Android手工测试的代码覆盖率</a></li>
</ul>
<h3 id="Jacoco与Jenkins的集成"><a href="#Jacoco与Jenkins的集成" class="headerlink" title="Jacoco与Jenkins的集成"></a>Jacoco与Jenkins的集成</h3><ul>
<li>Jenkins 集成Jacoco，其实其原理和上面提到的gradle的处理方式是比较类似的。</li>
<li>首先Jenkins需要安装一个【Jacoco plugin】，然后在项目配置文件中会有如下图所示的配置选项：<br><img src="/upload/image/zlw/jenkins-jacoco.png" alt="Jenkins-Jacoco"></li>
</ul>
<p>其主要配置如下：</p>
<ul>
<li>Path to Exec files：\app\build\outputs\code-coverage\connected\coverage.ec    这个路径是执行gradle任务时，生成的ec文件的目录。</li>
<li>Path to class directories:   \app\build\intermediates\classes\debug           这个路径是编译之后生成class所在的目录</li>
<li>Path to source directories :  /src/main/java            源代码所在路径</li>
<li>Inclusions： com/xxx/xxx/ *.class       包含哪些class文件。</li>
<li>Exclusions： <strong>/R.class, </strong>/R$<em>.class, <strong>/Manifest.class , </strong>/Manifest$</em>.class, **/BuildConfig.class<blockquote>
<ul>
<li>这里需要注意，路径结尾的/必须去掉，否则会有非预期的结果，其实也就是加载了我们不需要的目录。</li>
</ul>
</blockquote>
</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>代码覆盖率虽然对于项目质量不具有绝对的衡量意义，但是对于优化我们的测试用例及UI自动化脚本还是非常有用的。通过代码覆盖率结果，我们大致可以知道我们的UI自动化脚本对代码的覆盖程度。</li>
<li>因此应该推动代码覆盖率在项目中的应用。</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/01/安全扫描工具drozer的使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liwei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="利伟的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/01/安全扫描工具drozer的使用/" itemprop="url">
                  安全扫描工具drozer的使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-01T15:07:17+08:00">
                2017-03-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/测试工具/" itemprop="url" rel="index">
                    <span itemprop="name">测试工具</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/01/安全扫描工具drozer的使用/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/01/安全扫描工具drozer的使用/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><ul>
<li>Drozer是一个由 MWR 安全团队维护开源的软件，该软件是针对Android平台的安全审计和攻击框架。安全人员可以通过drozer自身提供的一些module完成一些基础的安全测试功能，同时也可以根据需求实现自己的module，甚至可以在利用drozer提供的框架实现一些自动化审计功能。</li>
<li>Drozer提供了一些工具来帮助你使用和分享Android上的公共利用漏洞。对于远程漏洞利用，它能生成shellcode来帮助你部署drozer代理端。</li>
</ul>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="PC客户端"><a href="#PC客户端" class="headerlink" title="PC客户端"></a>PC客户端</h3><ul>
<li>下载drozer ：<a href="https://labs.mwrinfosecurity.com/tools/drozer/" target="_blank" rel="external">drozer</a>，选择适合自己系统的版本。我这里选择的是Windows版本<a href="https://github.com/mwrlabs/drozer/releases/download/2.3.4/drozer-installer-2.3.4.zip" target="_blank" rel="external">windows</a>。</li>
<li>下载完之后，直接安装就好，Windows双击exe文件。</li>
<li>drozer没有界面，需要将drozer的安装目录配置到环境变量。因为后面要用drozer命令。</li>
<li>在下载的安装文件夹中，有一个agent.apk,是用于手机端的。</li>
</ul>
<h3 id="手机端"><a href="#手机端" class="headerlink" title="手机端"></a>手机端</h3><ul>
<li>上面提到的agent.apk,直接命令行adb install agent.apk安装就行。</li>
<li>如果上述文件夹中没有agent.apk，可以下载一个<a href="https://github.com/mwrlabs/drozer/releases/download/2.3.4/drozer-agent-2.3.4.apk" target="_blank" rel="external">apk</a></li>
<li>安装完apk后，打开应用，点击Embedded server开关，开启服务。</li>
</ul>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="创建连接"><a href="#创建连接" class="headerlink" title="创建连接"></a>创建连接</h3><ul>
<li>手机需要usb连接到PC，先用adb devices命令检查手机是否连上PC。</li>
<li>命令行执行adb forward tcp:31415 tcp:31415  ,adb forward的作用是将PC端31415端口的数据，转发到手机端31415端口，从而实现PC和手机的通信。</li>
<li>命令行执行 drozer console connect 用于连接手机端的agent，成功后会有如下图所示界面：<br><img src="/upload/image/zlw/drozer.PNG" alt="drozer img"></li>
<li>如果碰到【Error 10054】之类的错误，检查下手机端的服务是否开启成功。</li>
</ul>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><h4 id="获取包名"><a href="#获取包名" class="headerlink" title="获取包名"></a>获取包名</h4><ul>
<li>run app.package.list -f [app关键字]   查找某个app包名  -f[app关键字]用于通过关键字筛选</li>
</ul>
<h4 id="获取应用基本信息"><a href="#获取应用基本信息" class="headerlink" title="获取应用基本信息"></a>获取应用基本信息</h4><ul>
<li>run app.package.info -a packageName  返回对应包名的详细信息：权限、APKPATH等</li>
</ul>
<h4 id="确定攻击面"><a href="#确定攻击面" class="headerlink" title="确定攻击面"></a>确定攻击面</h4><ul>
<li>run app.package.attacksurface  packageName 查找攻击面，主要关注Android 固有的IPC通信机制的脆弱性，这些特点导致了这个App泄漏敏感信息给同一台设备上的其它App</li>
<li>我们首先运行上面这个命令确定哪些方面可能存在问题。</li>
<li>我们需要关注那些被export，但是并没有设置调用权限的组件：Activity、Service、BroadReceiver、ContentProvider</li>
</ul>
<h4 id="Activity"><a href="#Activity" class="headerlink" title="Activity"></a>Activity</h4><ul>
<li>run app.activity.info -a packageName ，上面命令可能找到了整体的攻击情况，这个命令用于进一步获取每个组件的攻击面信息，如activity</li>
<li>我们需要关注的是那些 除了首页Activity之外的所有【可导出且不需要权限的activity】，因为他们可以被随意的被其他应用启动。</li>
<li>run  app.activity.start  –component packageName  ActivityName 用drozer来启动对应的activity</li>
</ul>
<h4 id="检查Content-Provider问题"><a href="#检查Content-Provider问题" class="headerlink" title="检查Content Provider问题"></a>检查Content Provider问题</h4><h5 id="获取Content-Provider信息"><a href="#获取Content-Provider信息" class="headerlink" title="获取Content Provider信息"></a>获取Content Provider信息</h5><ul>
<li>run app.provider.info -a packageName 获取content provider的信息</li>
</ul>
<h5 id="Content-Providers（数据泄露）"><a href="#Content-Providers（数据泄露）" class="headerlink" title="Content Providers（数据泄露）"></a>Content Providers（数据泄露）</h5><ul>
<li>run scanner.provider.finduris -a packageName 用于查找对应包名的可能存在问题的URI</li>
<li>run app.provider.query –vertical URI        通过URI从content中获取信息，比如可以获取密码账号相关信息</li>
<li>run scanner.provider.injection  -a  packageName   检测可注入的URI的注入点</li>
</ul>
<h5 id="Content-Providers（SQL注入）"><a href="#Content-Providers（SQL注入）" class="headerlink" title="Content Providers（SQL注入）"></a>Content Providers（SQL注入）</h5><ul>
<li>run app.provider.query  URI –projection “‘“  使用projection参数传递sql注入语句到content provider中</li>
<li>run app.provider.query URI –projection “* from sqlite_master where type=’table’;–” –vertical    通过sql注入列出当前数据库DBContentProvider中的所有表名和字段名</li>
<li>run app.provider.query URI –selection “‘“  使用selection 参数传递sql注入语句到content provider中</li>
</ul>
<h5 id="同时检测SQL注入和目录遍历"><a href="#同时检测SQL注入和目录遍历" class="headerlink" title="同时检测SQL注入和目录遍历"></a>同时检测SQL注入和目录遍历</h5><ul>
<li>run scanner.provider.injection -a packageName</li>
<li>run scanner.provider.traversal -a packageName</li>
</ul>
<h4 id="intent组件触发（拒绝服务、权限提升）"><a href="#intent组件触发（拒绝服务、权限提升）" class="headerlink" title="intent组件触发（拒绝服务、权限提升）"></a>intent组件触发（拒绝服务、权限提升）</h4><h5 id="介绍名词"><a href="#介绍名词" class="headerlink" title="介绍名词"></a>介绍名词</h5><ul>
<li>拒绝服务：应用在使用getIntent()，getAction()，Intent.getXXXExtra()获取到空数据、异常或者畸形数据时没有进行异常捕获，应用就会发生Crash，应用不可使用（本地拒绝服务）。有些恶意应用可通过向受害者应用发送此类空数据、异常或者畸形数据从而使应用产生本地拒绝服务</li>
<li>权限提升：</li>
</ul>
<h5 id="查看暴露的广播组件信息"><a href="#查看暴露的广播组件信息" class="headerlink" title="查看暴露的广播组件信息"></a>查看暴露的广播组件信息</h5><ul>
<li>run app.broadcast.info -a com.package.name　　获取broadcast receivers信息</li>
<li>run app.broadcast.send –component 包名 –action android.intent.action.XXX</li>
</ul>
<h5 id="尝试拒绝服务攻击检测，向广播组件发送不完整intent（空action或空extras）"><a href="#尝试拒绝服务攻击检测，向广播组件发送不完整intent（空action或空extras）" class="headerlink" title="尝试拒绝服务攻击检测，向广播组件发送不完整intent（空action或空extras）"></a>尝试拒绝服务攻击检测，向广播组件发送不完整intent（空action或空extras）</h5><ul>
<li>run app.broadcast.send 通过intent发送broadcast receiver<h6 id="空action"><a href="#空action" class="headerlink" title="空action"></a>空action</h6></li>
<li>run app.broadcast.send –component 包名 ReceiverName<h6 id="空extras"><a href="#空extras" class="headerlink" title="空extras"></a>空extras</h6></li>
<li>run app.broadcast.send –action android.intent.action.XXX</li>
</ul>
<h4 id="检查service问题"><a href="#检查service问题" class="headerlink" title="检查service问题"></a>检查service问题</h4><ul>
<li>run scanner.service -a packageName</li>
</ul>
<h4 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h4><ul>
<li>run scanner.misc.writablefiles –privileged /data/data/com.sina.weibo</li>
<li>run scanner.misc.readablefiles –privileged /data/data/com.sina.weibo</li>
</ul>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><ul>
<li>我这里只是列出了命令，并没有结合具体的例子，大家可以参考<a href="http://www.cnblogs.com/1chavez/p/4492574.html" target="_blank" rel="external">drozer的使用</a>，这里的有一些更具具体的例子。</li>
<li>这里的大多数命令都是从其他地方copy过来的，我自己实践了一部分。这里也是为了记录下来预防之后会需要。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>安全扫描，对APK来说非常重要，因为不经意的一个漏洞，可能会对用户的财产造成损失（因为手机上绑定了用户的银行卡等信息）。</li>
<li>后面随着对安全扫描的熟悉，考虑将规则添加到静态代码扫描规则中。</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/02/24/主流UI自动化脚本对比/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liwei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="利伟的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/24/主流UI自动化脚本对比/" itemprop="url">
                  主流UI自动化脚本录制和执行工具对比
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-24T12:21:17+08:00">
                2017-02-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/测试工具/" itemprop="url" rel="index">
                    <span itemprop="name">测试工具</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/02/24/主流UI自动化脚本对比/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/24/主流UI自动化脚本对比/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><ul>
<li>最近和公司其他同学产生了一个想法，现在公司各个app，都需要有专门的人去写UI自动化脚本（appium），且推动不同业务的同学使用appium的过程比较缓慢，所以就想能不能搞个工具，在手机端操作，能自动生成对应的自动化脚本，这样可以大大提高工作效率且非常好推广。</li>
<li>工欲善其事，必先利其器，就花了一天的时间，把主流的脚本录制工具研究了一遍。</li>
</ul>
<h2 id="详细介绍"><a href="#详细介绍" class="headerlink" title="详细介绍"></a>详细介绍</h2><h3 id="Espresso"><a href="#Espresso" class="headerlink" title="Espresso"></a>Espresso</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><ul>
<li>这玩意是AndroidStudio从2.2+版本自带的一个工具，中文名叫浓咖啡，意思就是你喝着咖啡，就把活做了，老外在起名字上非常形象啊。它从界面到交互使用起来还是比较方便的。</li>
</ul>
<h4 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h4><ul>
<li>首先确保AndroidStudio的版本是2.2+。</li>
<li>确保你有app，能编译通过的源码。</li>
<li>菜单栏【Run】— 【Record Espresso Test】</li>
<li>接着就让你选择要执行脚本录制app的工程（如果你有多个model）以及哪个设备。</li>
<li>代码运行成功，会弹出一个【Record Your Test】的UI界面，这时候你只需要在手机端操作你的app就好了。如下图所示：<br><img src="/upload/image/zlw/espresso.PNG" alt="Espresso"></li>
<li>当你的用例执行完成之后，点击【Complete Recording】，就会生成对应的java脚本文件（会让你起个名字）。</li>
<li>接下来要做的是对java脚本做些调整就好了。（两个操作间插入间隔时间、逻辑）</li>
</ul>
<h4 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h4><h5 id="录制"><a href="#录制" class="headerlink" title="录制"></a>录制</h5><ul>
<li>Espresso录制时用到了BreakpointDescriptor、BreakpointCommand，它们是和调试程序相关的API。</li>
<li>说到这里，你大概能猜到了吧，Espresso在启动时会初始化很多BreakpointDescriptor，比如：performClick方法、onTextChanged方法等，换句话说它是在点击事件、EditText的文本变化打上了断点。</li>
<li>当用户在手机上操作app时，比如点击按钮时，会触发创建的断点，获取UI元素的详细信息。</li>
<li>当用户点击【Complete Recording】时，会将采集的内容，通过Apache的 Velocity 库，生成java文件。</li>
</ul>
<h5 id="执行脚本"><a href="#执行脚本" class="headerlink" title="执行脚本"></a>执行脚本</h5><ul>
<li><p>Espresso的java脚本如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">ViewInteraction button5 = onView(</div><div class="line">        allOf(withId(R.id.prepare), withText(<span class="string">"初始化接口"</span>), isDisplayed()));</div><div class="line">button5.perform(click());</div><div class="line"></div><div class="line">ViewInteraction button6 = onView(</div><div class="line">        allOf(withId(R.id.SecuritySDKManager), withText(<span class="string">"SecuritySDKManager"</span>), isDisplayed()));</div><div class="line">button6.perform(click());</div><div class="line"></div><div class="line">pressBack();</div><div class="line"></div><div class="line">ViewInteraction button7 = onView(</div><div class="line">        allOf(withId(R.id.SecurityGroupManager), withText(<span class="string">"SecurityGroupManager"</span>), isDisplayed()));</div><div class="line">button7.perform(click());</div><div class="line"></div><div class="line">pressBack();</div></pre></td></tr></table></figure>
</li>
<li><p>还是以点击按钮为例，跟踪代码进去perform方法，看它主要是调用了WindowManagerEventInjectionStrategy的injectKeyEvent。通过查看注释，这个方法是用来将KeyEvent事件注入到Android System。</p>
</li>
<li><p>我们再跟踪代码，发现其实也没啥高深的，它通过反射获取了WindowManager，通过它来注入事件，代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">IBinder wmbinder = ServiceManager.getService( <span class="string">"window"</span> );</div><div class="line">IWindowManager m_WndManager = IWindowManager.Stub.asInterface( wmbinder );</div><div class="line"><span class="comment">// key down</span></div><div class="line">m_WndManager.injectKeyEvent( <span class="keyword">new</span> KeyEvent( KeyEvent.ACTION_DOWN, KeyEvent.KEYCODE_A ),<span class="keyword">true</span> );</div><div class="line"><span class="comment">// key up</span></div><div class="line">m_WndManager.injectKeyEvent( <span class="keyword">new</span> KeyEvent( KeyEvent.ACTION_UP, KeyEvent.KEYCODE_A ),<span class="keyword">true</span> );</div></pre></td></tr></table></figure>
</li>
<li><p>不过这种方式，只针对自己的app，不能像其他app注入事件。</p>
</li>
<li>偷偷告诉你，monkey也是这么干的。。</li>
</ul>
<h4 id="不足之处"><a href="#不足之处" class="headerlink" title="不足之处"></a>不足之处</h4><ul>
<li>插入时间间隔不方便，需要自己写个方法来实现。</li>
</ul>
<h3 id="MonkeyTalk"><a href="#MonkeyTalk" class="headerlink" title="MonkeyTalk"></a>MonkeyTalk</h3><h4 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h4><ul>
<li>从官网copy过来的介绍：MonkeyTalk是世界上最强大的移动应用测试工具。它实现iOS及Android上真实的、功能交互的自动化测试 ——包括从最简单的冒烟测试到复杂的数据驱动测试集的所有的测试。它支持原生、移动、混合型应用，在虚拟机或者真实设备上。</li>
<li>MonkeyTalk分为社区版（免费）和 专业版（付费），不过可以找破解版的，我废了好大的劲找到（链接: <a href="http://pan.baidu.com/s/1dF1NagT" target="_blank" rel="external">http://pan.baidu.com/s/1dF1NagT</a> 密码: 1ksq）</li>
</ul>
<h4 id="使用方法-1"><a href="#使用方法-1" class="headerlink" title="使用方法"></a>使用方法</h4><h5 id="手机端"><a href="#手机端" class="headerlink" title="手机端"></a>手机端</h5><ul>
<li>MonkeyTalk需要在打测试apk时，集成一个monkeytalk-agent-xxx.jar（具体用Eclipse或者AndroidStudio配置参考<a href="https://testerhome.com/topics/3082）" target="_blank" rel="external">https://testerhome.com/topics/3082）</a></li>
<li>集成jar包后，打包成功即可。</li>
</ul>
<h5 id="PC端"><a href="#PC端" class="headerlink" title="PC端"></a>PC端</h5><ul>
<li>初次使用，感觉这货特别像Eclipse，要先建一个project，注意创建project选择【MonkeyTalk project】。</li>
<li>创建工程的过程很简单，大家根据软件的提示一步步的操作就行。</li>
<li>创建好工程之后，可以点击菜单栏那个像火箭发射的按钮，启动测试app，然后点击【Record】按钮就可以开始录制了。</li>
<li>在手机端执行你的用例，生成的脚本如下图所示：<br><img src="/upload/image/zlw/monkeytalk.PNG" alt="MonkeyTalk"></li>
<li>录制完成后，点击【stop】就自动保存了，然后点击【play all】就能开始执行脚本。</li>
<li>注意，点【play all】时，手机端app页面要切换到录制开始时的页面，否则会出现元素找不到的错误。</li>
</ul>
<h4 id="原理分析-1"><a href="#原理分析-1" class="headerlink" title="原理分析"></a>原理分析</h4><h5 id="录制-1"><a href="#录制-1" class="headerlink" title="录制"></a>录制</h5><ul>
<li>MonkeyTalk，使用了aspectj AOP编程，在onCreate（页面切换）、setListener（点击事件）、setText（文本框输入文本）等创建了切面，换句话说当用户操作手机时，上面提到的monkeytalk-agent.jar中的切面会拦截到点击、输入文本之类的操作，然后获取界面元素。（aspectj的原理我没花太多事件研究，感兴趣的可以研究下）</li>
<li>PC端开始录制时，会去创建RecordServer，它其实是去创建了一个serverSocket（端口是16861），用于监听手机端发送过来的数据，而上面提到手机端集成了一个agent的jar包，用于将采集到的UI元素及操作事件，通过这个serverSocket发送给PC。手机端的端口号是（16862）</li>
<li>PC端收到采集的数据，做展示，生成mt脚本。</li>
</ul>
<h5 id="执行脚本-1"><a href="#执行脚本-1" class="headerlink" title="执行脚本"></a>执行脚本</h5><ul>
<li>执行脚本时同样，在手机端会有一个PlayBackServer，用于接受PC端发送过来要执行的脚本。</li>
<li>这个过程中有两个关键的数据：monkeyId（元素的标识id或者tag）和ComponentType（Button、TextView），然后手机端拿到PC端发送的这两个值之后，会在当前页面遍历所有的View，找到对应的界面元素，执行相对应的操作（xxxAutomator的play方法）。</li>
<li>play方法是直接作用到Android View上的，比如滑动，最终会调用View.scrollTo()，这个也好理解，因为这个工具是直接dump到界面元素来进行操作的。</li>
</ul>
<h5 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h5><ul>
<li>我只是介绍了基本的原理，大家可以下载对应的源码，更深入的了解它是怎么工作的。</li>
</ul>
<h4 id="不足之处-1"><a href="#不足之处-1" class="headerlink" title="不足之处"></a>不足之处</h4><ul>
<li>生成的脚本维护性较差。</li>
<li>专业版软件要收费。</li>
</ul>
<h3 id="MonkeyRunner"><a href="#MonkeyRunner" class="headerlink" title="MonkeyRunner"></a>MonkeyRunner</h3><h4 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h4><ul>
<li>MonkeyRunner是Google自带的一款工具，通过它可以截屏、安装包、发送一些keyEvent，可以通过写python脚本实现。</li>
<li>MonkeyRunner也有录制脚本的功能，要通过两个脚本，record.py 和  playback.py，如下所示<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#recorder.py</span></div><div class="line"><span class="comment">#&lt;br&gt;__author__ = 'paul'</span></div><div class="line"><span class="keyword">from</span> com.android.monkeyrunner <span class="keyword">import</span> MonkeyRunner <span class="keyword">as</span> mr</div><div class="line"><span class="keyword">from</span> com.android.monkeyrunner.recorder <span class="keyword">import</span> MonkeyRecorder <span class="keyword">as</span> recorder</div><div class="line"></div><div class="line">device = mr.waitForConnection()</div><div class="line">recorder.start(device)</div></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#playback.py</span></div><div class="line"><span class="comment">#&lt;br&gt;__author__ = 'paul'</span></div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">from</span> com.android.monkeyrunner <span class="keyword">import</span> MonkeyRunner</div><div class="line"></div><div class="line">CMD_MAP = &#123;</div><div class="line">    <span class="string">"TOUCH"</span>: <span class="keyword">lambda</span> dev, arg: dev.touch(**arg),</div><div class="line">    <span class="string">"DRAG"</span>: <span class="keyword">lambda</span> dev, arg: dev.drag(**arg),</div><div class="line">    <span class="string">"PRESS"</span>: <span class="keyword">lambda</span> dev, arg: dev.press(**arg),</div><div class="line">    <span class="string">"TYPE"</span>:<span class="keyword">lambda</span> dev, arg:dev.type(**arg),</div><div class="line">    <span class="string">"WAIT"</span>:<span class="keyword">lambda</span> dev, arg:MonkeyRunner.sleep(**arg)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">#Process a single file for the specified device.</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_file</span><span class="params">(fp,device)</span>:</span></div><div class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> fp:</div><div class="line">        (cmd,rest) = line.split(<span class="string">"|"</span>)</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="comment">#Parse the pydict</span></div><div class="line">            rest = eval(rest)</div><div class="line">        <span class="keyword">except</span>:</div><div class="line">            <span class="keyword">print</span> <span class="string">"unable to parse options"</span></div><div class="line">            <span class="keyword">continue</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> cmd <span class="keyword">not</span> <span class="keyword">in</span> CMD_MAP:</div><div class="line">            <span class="keyword">print</span> <span class="string">"unknown command: "</span> + cmd</div><div class="line">            <span class="keyword">continue</span></div><div class="line"></div><div class="line">        CMD_MAP[cmd](device, rest)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    file = sys.argv[<span class="number">1</span>]</div><div class="line">    fp = open(file, <span class="string">"r"</span>)</div><div class="line"></div><div class="line">    device = MonkeyRunner.waitForConnection()</div><div class="line"></div><div class="line">    process_file(fp,device)</div><div class="line">    fp.close();</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><h5 id="录制-2"><a href="#录制-2" class="headerlink" title="录制"></a>录制</h5><ul>
<li>直接在命令行执行monkeyrunner record.py 打开UI界面。</li>
<li>然后在PC端的UI界面操作，界面上有几个按钮：<blockquote>
<p>1.wait： 用来插入下一次操作的时间间隔，点击后即可设置时间，单位是秒<br>2.Press a Button：用来确定需要点击的按钮，包括menu、home、search，以及对按钮的press、down、up属性<br>3.Type Something：用来输入内容到输入框，选中某个输入框<br>4.Fling：用来进行拖动操作，可以向上、下、左、右，以及操作的范围<br>5.Export Actions：用来导出脚本<br>6.Refresh Display：用来刷新手机界面，有时候界面反映太慢，可以强制刷新一下。</p>
</blockquote>
</li>
</ul>
<h5 id="播放"><a href="#播放" class="headerlink" title="播放"></a>播放</h5><ul>
<li>直接在命令行执行monkeyrunner playback.py xxx.py  (生成的python脚本)</li>
<li>执行脚本的时候，最好将录制脚本的UI关掉，否则会有影响。</li>
</ul>
<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><ul>
<li>moneyrunner主要用到了两个jar：ddmlib.jar和chimpchat.jar。</li>
<li>通过将PC端UI点击的坐标，根据比例转化成手机上的坐标，然后通过device执行。</li>
</ul>
<h4 id="不足之处-2"><a href="#不足之处-2" class="headerlink" title="不足之处"></a>不足之处</h4><ul>
<li>界面用起来比较卡顿。</li>
<li>基于坐标来生成自动化脚本，兼容性会有问题且不容易维护。</li>
</ul>
<h3 id="其他工具"><a href="#其他工具" class="headerlink" title="其他工具"></a>其他工具</h3><ul>
<li>其他工具还有atx、Appium Inpsector，但是我都没有搞成功过。感兴趣的可以研究下。</li>
<li>脚本录制的思路很明确，通过坐标或者代码插桩获取控件信息及操作类型。</li>
<li>脚本回放的思路也很明确，将脚本转换成设备可以执行的命令，或者直接在控件上执行方法。</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/02/16/Android页面流畅度测试/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liwei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="利伟的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/16/Android页面流畅度测试/" itemprop="url">
                  Android页面流畅度测试
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-16T14:48:51+08:00">
                2017-02-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android性能测试/" itemprop="url" rel="index">
                    <span itemprop="name">Android性能测试</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/02/16/Android页面流畅度测试/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/16/Android页面流畅度测试/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><ul>
<li>现在App，为了能更加吸引用户，总是会加入很酷炫的动画以及在列表中插入大量规格不一的图片，这么做可能会对页面流畅度造成一定的影响，给用户最直观的感受是APP变卡了，因此从测试的角度，了解一些页面显示的原理及测试工具的使用是很有必要的。</li>
<li>一般测页面流畅度会从两方面入手：页面过渡重绘 和 页面帧率测试，接下来我们围绕这两种情况进行介绍。</li>
</ul>
<h2 id="过渡重绘（overdraw）"><a href="#过渡重绘（overdraw）" class="headerlink" title="过渡重绘（overdraw）"></a>过渡重绘（overdraw）</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><ul>
<li>android系统绘制屏幕的时候，先画父view，然后子view，再是更深的子view等等。这会导致所有的view都被绘制到了屏幕上并且view是垂直摆放的（对我们可见的是子view，它下面是父view，以此类推），因此有些父View必然是不可见的，如果他们也绘制，我们就认为发生了过渡重绘。例如：一个白色背景的窗口，在它上面有一个按钮。当系统绘制按钮时，要绘制在已存在的白色背景上。</li>
<li>因为过渡重绘，不可见页面的绘制必然会占用可见页面绘制的时间和资源，所以会对页面流畅度造成影响。</li>
<li>Google给我们提供了工具来检测并快速定位过渡重绘：开发者选项——调试GPU过度绘制 选择【显示过度绘制区域】。</li>
</ul>
<h3 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h3><ul>
<li>勾选【显示过度绘制区域】后在屏幕上会呈现出不同的颜色，如下图所示：<br><img src="/upload/image/zlw/过度绘制1.png" alt="过度重绘"></li>
</ul>
<p>没有颜色（白色）： 意味着没有overdraw。像素只画了一次。<br>蓝色： 意味着overdraw 1倍。像素绘制了两次。（因为overdraw时，屏幕上同一位置像素点两个view都需要绘制）<br>绿色： 意味着overdraw 2倍。像素绘制了三次。<br>浅红： 意味着overdraw 3倍。像素绘制了四次。<br>暗红： 意味着overdraw 4倍。像素绘制了五次或者更多。</p>
<p>我们期望的情况是：</p>
<ul>
<li>页面尽量是没有overdraw，即白色。（但根据经验，这比较难达到）。</li>
<li>页面如果大部分是蓝色区域或者绿色区域，也是可以接受的。</li>
<li>页面浅红色的区域不能超过 1/3（通过估算），需要排查下原因，看能否优化成白色、蓝色或者绿色。</li>
<li>页面不能出现深红色的区域。</li>
</ul>
<h3 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h3><ul>
<li>在测试过程中，发现问题，最好能自己分析下错误的可能原因，即使自己没有找到问题的根本原因，但是也可以将自己发现的星星点点的可能原因在提bug的时候作为描述，告诉开发，这样可以提高问题被解决的效率，一定程度上提升了工作效率。</li>
</ul>
<p>碰到过渡重绘的问题，可以从以下几个思路来分析问题：</p>
<h4 id="页面层级太多"><a href="#页面层级太多" class="headerlink" title="页面层级太多"></a>页面层级太多</h4><ul>
<li><p>我们可以使用AndroidStudio monitor 【Layout Inspecter】工具（最好用最新版，记得之前的版本好像还没集成Layout Inspecter），如下图所示：<br><img src="/upload/image/zlw/LayoutInspecter.PNG" alt="LayoutInspector"></p>
</li>
<li><p>抓取到的结果如下图所示：<br><img src="/upload/image/zlw/LayoutInspecterResult.PNG" alt="过渡重绘"></p>
</li>
<li><p>上图第1部分是界面元素的构成情况，是分层展示的。可再回过头去想下上面提到的子view和父view的关系。</p>
</li>
<li>上图第2部分是我们能看到的界面的样子，鼠标在上面移动，图中第1和3部分也会跟着改变值。</li>
<li><p>上图第3部分是我们在第2部分选中view的一些属性值。比如我们写UI自动化时，可以从这里查看坐标或者元素id。</p>
</li>
<li><p>我截取了我认为有问题的元素，如下图所示：<br>!<img src="/upload/image/zlw/过渡重绘.PNG" alt="过渡重绘实例"></p>
</li>
<li><p>这个页面，三个item都是淡红色的，查看他们布局，我觉得用红线圈中的第二个LinearLayout可以考虑去掉，直接用RelativeLayout来实现，这样可以节省一层。</p>
</li>
<li>不过对布局问题的排查，需要一些Android界面的基础知识，但也不难，大家可以熟悉常见的几种布局即可。RelativeLayout、LinearLayout、FrameLayout。</li>
</ul>
<h4 id="去掉View没必要的背景色"><a href="#去掉View没必要的背景色" class="headerlink" title="去掉View没必要的背景色"></a>去掉View没必要的背景色</h4><ul>
<li>这种问题也比较常见，开发在写布局时，经常先加个背景，方便调整界面，但是完成之后，背景可能被其他的View覆盖，就忘记去掉。</li>
<li>不过这个需要有布局文件才能去查看，可以问开发要一份代码，便于分析问题。</li>
<li>但是如果没有开发代码，也可以通过 apktool 命令来反编译apk的资源文件，也是可以拿到布局文件的。（不过现在有的公司已经将资源文件也处理了，比如360，但大部分的还是可以的）</li>
</ul>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ul>
<li>从开发的角度，还有其他优化方案，不过我们从测试的角度，能分析到这个程度已经可以了，循序渐进，慢慢再去挖掘更多的解决方案。</li>
</ul>
<h2 id="FPS（页面帧率）"><a href="#FPS（页面帧率）" class="headerlink" title="FPS（页面帧率）"></a>FPS（页面帧率）</h2><h3 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h3><h4 id="60fps-VS-16ms-VS-60HZ"><a href="#60fps-VS-16ms-VS-60HZ" class="headerlink" title="60fps VS 16ms VS 60HZ"></a>60fps VS 16ms VS 60HZ</h4><ul>
<li>60HZ是屏幕的刷新频率，即1s内，屏幕被刷新来展示数据的次数。</li>
<li>60fps是系统1s内绘制的图像帧的数目，有一些对比数据，让我们更好的理解fps， 书本快速翻页（小时候看的那种小人书）是12fps， 电影胶片的帧率是24fps。30fps已经能够展示相对流畅的画面，而60fps能够将画面展示的更加逼真和绚丽。不过大于60fps，对于人类的眼睛已经没有什么区别了，但fps越高，硬件成本会提高，所以Google将帧率的标准定为60（页面流畅的标准，理论上小于这个值，页面会有卡顿感）。不过有人肯定会有疑问，为啥电影用24fps就够了，那是因为电影胶片的一帧带有一些方向及动态元素，而手机上的一帧就是静态的一帧（之前其实尝试过高帧电影，但效果不理想，现在还在不断尝试）。</li>
<li>16ms是系统绘制一帧的时间，计算方法 = 1s / 60 fps   约等于16ms。</li>
</ul>
<h3 id="工具-1"><a href="#工具-1" class="headerlink" title="工具"></a>工具</h3><h4 id="AndroidStudio测试工具介绍"><a href="#AndroidStudio测试工具介绍" class="headerlink" title="AndroidStudio测试工具介绍"></a>AndroidStudio测试工具介绍</h4><ul>
<li><p>最新的AndroidStudio monitor已经集成了GPU测试工具，如下图所示：<br>!<img src="/upload/image/zlw/monitor_Gpu.PNG" alt="GPU"></p>
</li>
<li><p>图中 1 是个【Launch in GFX trace mode】,可以用来trace 图形加载过程中每一帧的绘制过程，这个非常有用，可以很准备的查看每一帧都绘制了什么。但需要一些gl绘制命令的知识，目前我也没搞太明白。研究中。</p>
</li>
<li>图中2 是四种色值（因为我用的5.x的手机，6.x的设备有9种色值，将绘制的过程更加的细化），我这里就介绍下四种色值的情况，对于6.x设备的情况，大家可以自己查一下去了解：</li>
</ul>
<blockquote>
<ol>
<li>蓝色（draw）代表CPU buildDisplayList的时间，换句话就是View执行onDraw方法的时间，如果蓝色占比较多，表示View比较复杂，造成onDraw耗时。</li>
<li>紫色（prepare）是5.x系统新增的，因为从5.x新增了Render Thread 专门用来渲染view（在这个过程中，UI thread 可以用来去处理之后的帧）， 紫色表示CPU 中 UI thread 往Render Thread写数据的时间。紫色较多，表示需要传递的数据太多，还是反映View复杂。</li>
<li>红色（Process）表示drawDisplayList的时间，即执行前面创建的DisplayList，转换成OpenGL命令，所以DisplayList越多，那么这个过程耗时就越多，换句话说是界面上元素较多且元素的种类也多。这里可以研究下纹理的概念。</li>
<li>橙色（Execute）发送OpenGL命令到GPU。这个阶段是一个阻塞调用，因为CPU在这里只会发送一个含有一些OpenGL命令的缓冲区给GPU，并且等待GPU返回空的缓冲区以便再次传递下一帧的OpenGL命令。而这些缓冲区的总量是一定的，如果GPU太过于繁忙，那么CPU则会去等待下一个空缓冲区。所以，如果我们看到这一阶段耗时比较长，那可能是因为GPU过于繁忙的绘制UI，而造成这个的原因则可能是在短时间内绘制了过于复杂的view。</li>
</ol>
</blockquote>
<ul>
<li>x轴代表测试的时间。</li>
<li>y轴代表的一帧绘制的时间。</li>
<li>此外，和X轴平行的还有一根绿线和红线。绿线表示的是60fps，红线表示的是30fps。</li>
</ul>
<h4 id="Android手机上测试工具"><a href="#Android手机上测试工具" class="headerlink" title="Android手机上测试工具"></a>Android手机上测试工具</h4><ul>
<li><p>此外Android手机上也有GPU调试工具，在【开发者选项】—— 【GPU呈现模式分析】 选择【在屏幕上显示为条形图】，这样在手机上就能看到展示了，如下图所示：<br><img src="/upload/image/zlw/android_gps.png" alt="Android_gps"></p>
</li>
<li><p>它的色值代表的含义和AndroidStudio工具的是一样的。</p>
</li>
<li>上面提到的两种工具都可以，根据自己的需要选择。</li>
</ul>
<h4 id="其他工具"><a href="#其他工具" class="headerlink" title="其他工具"></a>其他工具</h4><ul>
<li>腾讯的GT，腾讯提出来页面流畅度的概念，认为fps并不能代表页面是否流畅的标准，因为在不滑动的时候，fps为0，但并不能说页面不流畅，所以fps也并不是越小页面越不流畅。它们认为1s内有多少vsync，才能代表页面是否流畅，详细介绍可参考<a href="http://mp.weixin.qq.com/s?__biz=MzA3NTYzODYzMg==&amp;mid=208258190&amp;idx=2&amp;sn=22af4f01a6090599da3dca4c44f0f396&amp;scene=21#wechat_redirect" target="_blank" rel="external">如何量化Android应用的“卡”？—流畅度原理&amp;定义篇</a></li>
<li>因为我觉得测fps时，我们一般会在不断滑动和操作页面，理论上可排除静止时fps为0的情况，我们暂时还推荐用AndroidStudio的工具。不过我们要知道有这么回事。</li>
</ul>
<h3 id="问题排查-1"><a href="#问题排查-1" class="headerlink" title="问题排查"></a>问题排查</h3><ul>
<li>帧率问题排查相对CPU、Memory等，略复杂，很多时候需要多种工具结合起来使用，并且需要对Android的一些绘制原理比较熟悉，所以这里如果不结合具体实例，可能讲不明白，后面碰到具体问题，再写一篇文章介绍。</li>
<li>一般会用到的工具，【traceView】【systrace】【OpenGL Trace（和上面提到的AndroidStudio GPU monitor中的GFX trace类似）】。</li>
</ul>
<h4 id="分析问题的大致思路"><a href="#分析问题的大致思路" class="headerlink" title="分析问题的大致思路"></a>分析问题的大致思路</h4><p>这里只能先写点假如我碰到卡顿问题怎么去分析的思路：</p>
<ul>
<li>首先在滑动过程中，用traceView抓一个trace，分析onDraw()方法比较耗时的操作，或者列表滑动时，是否重复的Infalate()。主要是找和View的绘制相关的方法，是否有耗时的方法。</li>
<li>如果TraceView没有找到任何问题思路，可以用DDMS中【systrace】，这个工具是抓取系统所有的CPU及其线程在做哪些操作。我们可以找到RenderThread线程，找到有丢帧的点，然后具体分析为啥丢帧（最新版的工具，会有alert，告诉用户耗时原因），结合着其他线程在做什么任务分析。不过最后还是要回归代码去查看具体的情况或者再回到TraceView有针对性的查看对应的方法。</li>
<li>如果上面两种工具都不行，则要用杀手锏了DDMS中的【OpenGL trace】，它记录了每一帧的绘制情况，可以查看绘制帧的过程都调用了哪些方法及其耗时。我对这个工具，用的也不多，还需要多解决问题，多分析才能熟练。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>页面流畅度，我觉得多用于列表页面（可滑动）、动画复杂页面、View比较复杂页面，对于一般的展示页面，比如设置页面（一页显示完不可滑动），帧率测试可作为参考选项。</li>
<li>测页面流畅度，尽量选择性能比较差的手机，因为性能差的手机，更容易暴露问题。</li>
<li>分析问题是个耗时且高度专注的过程。</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/02/13/Android7-0新特性/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liwei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="利伟的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/13/Android7-0新特性/" itemprop="url">
                  Android7.0新特性
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-13T20:03:15+08:00">
                2017-02-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android知识/" itemprop="url" rel="index">
                    <span itemprop="name">Android知识</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/02/13/Android7-0新特性/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/13/Android7-0新特性/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><ul>
<li>Android7.0已经发布有些日子了，Android7.2.3马上也要出来了，我整理了一些Android7.0的特性，对测试过程中需要注意的点进行了分析。</li>
</ul>
<h4 id="Doze-打盹模式-加强版"><a href="#Doze-打盹模式-加强版" class="headerlink" title="Doze(打盹模式)加强版"></a>Doze(打盹模式)加强版</h4><h6 id="对应改动点"><a href="#对应改动点" class="headerlink" title="对应改动点"></a>对应改动点</h6><ul>
<li>打盹模式其实是从6.0就增加的特性，不过7.0是加强版。</li>
<li>当设备屏幕关闭一定时间后（无论充电与否，6.0只有在未充电时）设备会进入打盹模式第一部分限制：关闭应用网络访问和CPU、推迟作业和同步。</li>
<li>设备处于打盹模式并且静止一段时间后，系统会对WakeLock、AlarmManager、GPS和Wi-Fi扫描等。</li>
<li>在打盹模式下，系统会有一个时间窗口，在设定的场景下，集中执行我们想要执行的作业/同步。Google从6.0时就建议用Schedule的方式来执行任务。</li>
<li>在Doze模式中还有一种Standy的模式（从android6.0就有），这个模式也称之为应用待机模式，即：用户长时间未与应用发生交互时，Android系统会使应用进入空闲状态。</li>
</ul>
<h6 id="测试点"><a href="#测试点" class="headerlink" title="测试点"></a>测试点</h6><ul>
<li>app的保活进程在静置一段时间后，是否还能存活。</li>
<li>app在静置时能否及时的同步消息，比如安通+能否及时收到消息。</li>
<li>app心跳包的时间间隔是否随着时间的增加而增加。</li>
<li>对于性能测试，需要关注电量消耗。</li>
</ul>
<h6 id="优化建议"><a href="#优化建议" class="headerlink" title="优化建议"></a>优化建议</h6><ul>
<li>使用JobSchedule来执行心跳包的逻辑或者定时同步消息的任务。</li>
</ul>
<h6 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h6><ul>
<li><p>运行adb命令使系统进入Doze模式：<br>adb shell dumpsys battery unplug<br>adb shell dumpsys deviceidle step</p>
</li>
<li><p>测试stanby模式<br>adb shell dumpsys battery unplug<br>adb shell am set inactive packageName true<br>(true时代表进入模式，  false时恢复)</p>
</li>
</ul>
<h4 id="隐式广播优化"><a href="#隐式广播优化" class="headerlink" title="隐式广播优化"></a>隐式广播优化</h4><h6 id="改动点"><a href="#改动点" class="headerlink" title="改动点"></a>改动点</h6><ul>
<li>应用不再接收静态注册的CONNECTIVITY_ACTION广播，但是应用在前台<br>时可以接收动态注册的CONNECTIVITY_CHANGE广播。</li>
<li>应用不能发送或者接收ACTION_NEW_PICTURE和ACTION_NEW_VEDIO广播</li>
<li>主要为了减少设备的唤醒，节省内存和电量</li>
</ul>
<h6 id="测试点-1"><a href="#测试点-1" class="headerlink" title="测试点"></a>测试点</h6><ul>
<li>app中涉及到网络切换场景的，需要注意适配，比如：某些保活进程会监听网络切换来发送心跳、监听网络状态变化去下载大文件、监听网络状态去同步数据，可重点测试app置于后台的场景。</li>
<li>app中有涉及到拍照片及录视频的场景，逻辑是否正常（照片能否正常加载、视频录制完的逻辑）。</li>
</ul>
<h6 id="优化建议-1"><a href="#优化建议-1" class="headerlink" title="优化建议"></a>优化建议</h6><p>这里的参考方案都是针对网络状态变化广播的</p>
<ul>
<li>使用JObSchedule。</li>
<li>动态注册广播，监听CONNECTIVITY_CHANGE的广播，前提是应用在前台运行时。</li>
<li>使用ConnectivityManager，通过回调来监听网络变化。</li>
</ul>
<h4 id="权限变更（系统权限更改）"><a href="#权限变更（系统权限更改）" class="headerlink" title="权限变更（系统权限更改）"></a>权限变更（系统权限更改）</h4><h6 id="改动点-1"><a href="#改动点-1" class="headerlink" title="改动点"></a>改动点</h6><ul>
<li>优化了Android6.0中动态获取权限的方式，封装性更好。</li>
<li>app不能使用私有文件（/data/data/package/目录）的文件权限，也就是不能直接通过File的API来访问文件。</li>
<li>DownloadManager不再按文件名（通过 COLUMN_LOCAL_FILENAME）获取私人存储路径。</li>
</ul>
<h6 id="测试点-2"><a href="#测试点-2" class="headerlink" title="测试点"></a>测试点</h6><ul>
<li>涉及到权限申请的逻辑是否正常（读取联系人、写文件等）</li>
<li>目前，这种限制还没有完全生效，仍然可以通过File来访问自有文件</li>
<li>app中有访问本地文件的操作，比如浏览文件、读取某个文件的操作是否正常。</li>
<li>下载一般文件的逻辑，通常都是自己写的，不会用到DownloadManager，可以结合代码全局搜索下是否使用了DownloadManager。</li>
<li>若没有代码，可直接验证app中下载大文件的逻辑是否正常。</li>
</ul>
<h4 id="应用间共享文件"><a href="#应用间共享文件" class="headerlink" title="应用间共享文件"></a>应用间共享文件</h4><h6 id="测试点-3"><a href="#测试点-3" class="headerlink" title="测试点"></a>测试点</h6><ul>
<li>Android系统强制执行了StrictMode API政策，禁止向你的应用外公开<br>File://Uri。</li>
<li>如果其他应用通过Intent包含File://Uri来访问你的文件，则会抛FileUriExposedException的异常。</li>
<li>比如 系统相机拍照、裁剪照片。</li>
</ul>
<h6 id="测试点-4"><a href="#测试点-4" class="headerlink" title="测试点"></a>测试点</h6><ul>
<li>验证app中，有加载本地图片、拍照（意见反馈及添加图片）的用例，看是否正常。</li>
</ul>
<h6 id="优化建议-2"><a href="#优化建议-2" class="headerlink" title="优化建议"></a>优化建议</h6><ul>
<li>通过FileProvider解决。FileProvider的使用方法可以自行查询。</li>
<li>裁剪图片推荐TakePhoto开源库</li>
</ul>
<h4 id="无障碍改进"><a href="#无障碍改进" class="headerlink" title="无障碍改进"></a>无障碍改进</h4><h6 id="改动点-2"><a href="#改动点-2" class="headerlink" title="改动点"></a>改动点</h6><ul>
<li>屏幕缩放：支持用户设置显示尺寸，放大或者缩小屏幕上的元素，从而提升设备对视力不佳用户的可访问性。</li>
<li>当屏幕密度发生变化时，所有进程（包括前台和后台）都会收到有关配置变更的通知。</li>
</ul>
<h6 id="测试点-5"><a href="#测试点-5" class="headerlink" title="测试点"></a>测试点</h6><ul>
<li>在屏幕宽度为320dp的设备上测试app，确保其逻辑正常，无按钮不能点甚至crash出现。</li>
<li>屏幕缩小和放大，app的界面和逻辑是否正常，内容是否能展示完全。</li>
</ul>
<h6 id="优化建议-3"><a href="#优化建议-3" class="headerlink" title="优化建议"></a>优化建议</h6><ul>
<li>避免用像素单位制定尺寸，因为像素不会随屏幕密度缩放，应该使用dp与像素无关的单位。<h4 id="NDK应用链接至平台库"><a href="#NDK应用链接至平台库" class="headerlink" title="NDK应用链接至平台库"></a>NDK应用链接至平台库</h4><h6 id="改动点-3"><a href="#改动点-3" class="headerlink" title="改动点"></a>改动点</h6></li>
<li>NDK，只能使用Android平台提供的公开API</li>
<li>如果使用了非公开API，在Android7.0的设备上运行的APP在日志消息输出中生成一个错误，并且会在手机上作为消息显示。</li>
</ul>
<h6 id="测试点-6"><a href="#测试点-6" class="headerlink" title="测试点"></a>测试点</h6><ul>
<li>主要是App的稳定性，APP启动过程和功能模块加载过程（可能会用到NDK库的场景）中是否会有crash</li>
</ul>
<h4 id="多屏模式"><a href="#多屏模式" class="headerlink" title="多屏模式"></a>多屏模式</h4><h6 id="改动点-4"><a href="#改动点-4" class="headerlink" title="改动点"></a>改动点</h6><ul>
<li>可以拖拽app在屏幕上同时运行两个应用，比如可以同时浏览网页和写邮件</li>
<li>这种情况下，会忽略屏幕旋转的配置。</li>
</ul>
<h6 id="测试点-7"><a href="#测试点-7" class="headerlink" title="测试点"></a>测试点</h6><ul>
<li>主要是界面的适配，比如界面元素能否显示完全，滚动条是否可以正常使用等。</li>
<li>app的交互逻辑是否正常，比如：页面跳转、点击事件等。</li>
</ul>
<h4 id="逐步引入JDK8-0"><a href="#逐步引入JDK8-0" class="headerlink" title="逐步引入JDK8.0"></a>逐步引入JDK8.0</h4><h6 id="改动点-5"><a href="#改动点-5" class="headerlink" title="改动点"></a>改动点</h6><ul>
<li>主要改动是会引入一些新的语法及去掉一些不再使用的方法</li>
<li>其他java8的特性，比如：Lambdas</li>
</ul>
<h6 id="测试点-8"><a href="#测试点-8" class="headerlink" title="测试点"></a>测试点</h6><ul>
<li>app的整体的兼容性，是否有crash。比如：ArrayList实现中的私有属性array被移除，假如用到它，就可能会crash。</li>
<li>牵扯到一些api的变更，需要整体适配。</li>
</ul>
<h4 id="通知增强功能"><a href="#通知增强功能" class="headerlink" title="通知增强功能"></a>通知增强功能</h4><h6 id="改动点-6"><a href="#改动点-6" class="headerlink" title="改动点"></a>改动点</h6><ul>
<li>自定义消息样式（可以设计和自己app符合的样式）</li>
<li>捆绑通知（消息设置成组）</li>
<li>直接回复</li>
<li>自定义视图</li>
</ul>
<h6 id="测试点-9"><a href="#测试点-9" class="headerlink" title="测试点"></a>测试点</h6><ul>
<li>验证app通知展示及逻辑是否正常。</li>
<li>验证app通知直接回复是否可以正常使用。</li>
</ul>
<h4 id="JIT-AOT编译"><a href="#JIT-AOT编译" class="headerlink" title="JIT/AOT编译"></a>JIT/AOT编译</h4><h6 id="测试点-10"><a href="#测试点-10" class="headerlink" title="测试点"></a>测试点</h6><ul>
<li>安装APK时不再编译成本地机器码，而只是解释字节码（类似Dalvik）</li>
<li>ART有一种更快的解释器，通过一种新的JIT完成。代码在执行期间被分析，分析结果保存起来，当设备空闲或者充电时，ART会对 执行频繁的代码进行编译成机器码。</li>
</ul>
<h4 id="Data-Saver"><a href="#Data-Saver" class="headerlink" title="Data Saver"></a>Data Saver</h4><h6 id="改动点-7"><a href="#改动点-7" class="headerlink" title="改动点"></a>改动点</h6><ul>
<li>主要是为了限制后台应用的流量消耗（针对蜂窝网络：4G、3G、2G）</li>
<li>开启Data Saver之后，后台应用无法访问网络，可以通过intent启动Data Saver设置页面</li>
</ul>
<h6 id="测试点-11"><a href="#测试点-11" class="headerlink" title="测试点"></a>测试点</h6><ul>
<li>验证app在Data Saver开启之后的逻辑是否正常：比如是否能拉起设置页面。</li>
<li>验证开启Data Saver之后，心跳包逻辑是否正常（是否会不停做无意义的重连操作等）。</li>
</ul>
<h4 id="其他重要说明"><a href="#其他重要说明" class="headerlink" title="其他重要说明"></a>其他重要说明</h4><h6 id="改动点-8"><a href="#改动点-8" class="headerlink" title="改动点"></a>改动点</h6><ul>
<li>因为屏幕可以缩放，在Android7.0及以上版本，当屏幕密度发生变化时不会终止所有的应用。</li>
<li>在Android7.0以下的版本，当屏幕密度发生变化时，会终止应用的进程。</li>
<li>Android7.0上的应用能够妥善处理配置变更。</li>
<li>新增了StrictMode在主线程写TCP套接字数据的判断，会抛出android.os.NetworkOnMainThreadException。</li>
<li>Debug.startMethodTracing()方法抓取的trace文件不再存储到sdcard，而是放到上面提到的共享存储空间特定目录中。</li>
<li>检查Binder事务间发送的大负载，比如在Activity.onSaveInstance()上传过多的数据。这会引发RuntimeException</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/02/08/Adb工作原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liwei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="利伟的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/08/Adb工作原理/" itemprop="url">
                  Adb工作原理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-08T19:32:09+08:00">
                2017-02-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android技术/" itemprop="url" rel="index">
                    <span itemprop="name">Android技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/02/08/Adb工作原理/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/08/Adb工作原理/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><ul>
<li>Adb是Android Debug bridge的简称，Android的初衷是用adb这样的一个工具来协助开发人员在开发android应用的过程中更快更好的调试apk，因此adb具有安装卸载apk、拷贝推送文件、查看设备硬件信息、查看应用程序占用资源、在设备执行shell命令等功能。</li>
<li>对于和Android打交道的同学，对Adb一定不陌生，每天的工作基本都离不开它，最近有时会碰到Adb的问题，比如adb server没有响应之类的，因此就想弄清楚Adb的工作原理到底是怎么样的？这样再碰到问题就能知道大概该怎么样去解决。</li>
<li>其实之前看过adb的源码，但是时间久远，看过的东西都忘记了，只能从头来了解。这次写下来，便于自己查看，更为了能跟感兴趣的同学交流。</li>
<li>我这里就不再去扣源码（源码在system/core/adb）了，主要是以介绍原理为主。</li>
</ul>
<h2 id="概念介绍"><a href="#概念介绍" class="headerlink" title="概念介绍"></a>概念介绍</h2><h3 id="Adb-是C-S架构，要了解其工作原理，其实就是要搞清楚下面三个概念："><a href="#Adb-是C-S架构，要了解其工作原理，其实就是要搞清楚下面三个概念：" class="headerlink" title="Adb 是C/S架构，要了解其工作原理，其实就是要搞清楚下面三个概念："></a>Adb 是C/S架构，要了解其工作原理，其实就是要搞清楚下面三个概念：</h3><ul>
<li>adb server</li>
<li>adb client</li>
<li>adb deamon</li>
</ul>
<p>接下来就分开介绍下他们的原理</p>
<h4 id="adb-server"><a href="#adb-server" class="headerlink" title="adb server"></a>adb server</h4><ul>
<li>ADB Server是运行在主机上的一个后台进程。它有两个作用：1）检测USB端口感知设备的连接和拔除，以及模拟器实例的启动或停止；2）将adb client的请求通过usb或者tcp的方式发送到对应的adbd上。</li>
<li>ADB server默认监听5037端口，我们可以通过在cmd命令行输入netstat -nao | findStr 5037 来查看哪个pid的进程在监听5037，我电脑上的pid = 13740，然后再通过tasklist来查看13740对应的应用程序是啥？如下图可以看到是adb.exe（就是adb server）。<br><img src="/upload/image/zlw/adb_tasklist.png" alt="Adb server的进程"></li>
</ul>
<h4 id="adb-client"><a href="#adb-client" class="headerlink" title="adb client"></a>adb client</h4><ul>
<li>adb client 可以是命令行，也可能是DDMS等工具。它运行在开发用的电脑上。</li>
<li>它主要的工作是：解析像：push、shell、install等命令的参数，做必要预处理，然后转移为指令或数据，发送给adb Server。</li>
<li>我们在命令行执行命令时，会创建一个adb.exe的client，命令执行完后就被销毁掉。（可以在PC的任务管理器中查看）</li>
<li>当启动adb客户端时，客户端首先检测adb服务端进程是否运行，如果没有运行，则启动服务端。当服务端启动时，它会绑定到本地的5037端口，并且监听从adb client发来的命令——所有的adb客户端都使用5037端口与adb服务端通信。</li>
</ul>
<h4 id="adb-deamon-adbd"><a href="#adb-deamon-adbd" class="headerlink" title="adb deamon(adbd)"></a>adb deamon(adbd)</h4><ul>
<li>adbd 是运行在Android设备（真机/模拟器）后台的一个进程，它是由init进程启动的，并且系统一开机就已经启动。</li>
<li>adbd存在于设备/sbin(我的目录是sbin，也可能是xbin)目录下。如下图所示：<br><img src="/upload/image/zlw/adbd_sbin.png" alt="adbd进程"></li>
<li>它的主要作用是处理来自 adb server的命令行请求，然后获取对应Android设备的信息，再将结果返回给adb server。</li>
</ul>
<h2 id="通信原理"><a href="#通信原理" class="headerlink" title="通信原理"></a>通信原理</h2><h3 id="清楚了上面的三个概念，相信对他们的通信原理应该已经有了比较清楚的认识。对熟悉他们通信原理就比较容易了。"><a href="#清楚了上面的三个概念，相信对他们的通信原理应该已经有了比较清楚的认识。对熟悉他们通信原理就比较容易了。" class="headerlink" title="清楚了上面的三个概念，相信对他们的通信原理应该已经有了比较清楚的认识。对熟悉他们通信原理就比较容易了。"></a>清楚了上面的三个概念，相信对他们的通信原理应该已经有了比较清楚的认识。对熟悉他们通信原理就比较容易了。</h3><h4 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h4><p><img src="/upload/image/zlw/Adb_logic.png" alt="概要流程图"><br><img src="/upload/image/zlw/adb_logic2.png" alt="具体流程图"></p>
<ul>
<li>第一张图是个概要的流程图，大致介绍了他们之间的通信流程。</li>
<li>第二张图更详细的介绍了通信流程，包括有哪些线程及adbd位于Android系统的内核中、在DDMS中经常看到的JDWP线程等等。</li>
<li>第二张图提到了TCP/Ip 和USb 两种通信方式，其中前者用于模拟器的通信（真机wifi连接），后者用于与真机的通信。</li>
</ul>
<h4 id="流程用文字描述"><a href="#流程用文字描述" class="headerlink" title="流程用文字描述"></a>流程用文字描述</h4><ul>
<li>client调用某个adb命令，比如adb push。</li>
<li>adb进程fork出一个子进程作为server（PC端的常驻进程）</li>
<li>server查找当前连接的emulator/device（查找客户端，为通信做准备）</li>
<li>server接收到来自client请求。（用户在命令行或者通过工具执行命令）</li>
<li>server处理请求，将本地处理不了的请求发给emulator/device（本地能处理的请求比如：adb devices 等）</li>
<li>位于emulator/device的adbd拿到请求后交给对应的java虚拟机进程（adbd收到请求会搞一个读和一个写进程用于收和回信息）。</li>
<li>adbd将结果发回给server</li>
<li>server讲结果发回给client（在工具中或者命令行界面展示结果）</li>
</ul>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><ul>
<li><p>The connection to adb is down, and a severe error has occured.You must restart adb and Eclipse.Please ensure that adb is correctly located at ‘adb.exe’ and can be executed</p>
<blockquote>
<ul>
<li>重启下adb server   （adb kill-server adb start-server）</li>
</ul>
</blockquote>
</li>
<li><p>ADB server didn’t ACK <em> failed to start daemon </em></p>
<blockquote>
<ul>
<li>在任务管理器中查找5037端口被谁占用了，然后结束掉。</li>
</ul>
</blockquote>
</li>
<li><p>待不断补充……………………</p>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/03/retrofit源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Liwei">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="利伟的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/03/retrofit源码分析/" itemprop="url">
                  Retrofit简单实用及源码分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-12-03T14:49:23+08:00">
                2016-12-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android开源库/" itemprop="url" rel="index">
                    <span itemprop="name">Android开源库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/12/03/retrofit源码分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/03/retrofit源码分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><ul>
<li>Retrofit是Square公司开发的一款针对Android网络请求的框架，Retrofit2底层基于OkHttp实现的。</li>
<li>官方对它的解释是：A type-safe HTTP client for Android and Java ，就是一个安全的可用于Android和java的网络库。</li>
<li>它可以简化我们操作网络的成本，其实所有第三方库的功能，我们用原生的api都是可以实现的，只不过需要花费时间和精力，且在某些场景下可能出现bug和性能不太好，而第三方开源库已经有很多产品使用，得到了验证和完善，所以我们推荐使用第三方库，不过我们需要对开源库的实现原理了解，这样在出现问题的时候能方便的排查问题。</li>
</ul>
<h3 id="Rest-API"><a href="#Rest-API" class="headerlink" title="Rest API"></a>Rest API</h3><ul>
<li>这里简单说下什么是Rest API。 REST是一种架构风格，用于创建Web服务，几乎总是工作在HTTP上。它的工作原理几乎以同样的方式得到的网页，但你也有标准的方法来创建，更新和删除。</li>
</ul>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><ul>
<li><p>首先可以定义一个interface，代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">APIService</span> </span>&#123;</div><div class="line">  <span class="meta">@GET</span>(<span class="string">"News"</span>)</div><div class="line">  <span class="function">Call&lt;ResponseBody&gt; <span class="title">getNews</span><span class="params">(</span></span></div><div class="line">          @Query(<span class="string">"limit"</span>) String limit);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>可以定义一个ServiceManager，里面用来初始化Retrofit，代码如下：</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Retrofit retrofit =<span class="keyword">new</span> Retrofit.Builder()</div><div class="line">              .baseUrl(<span class="string">"http://hcy.com/api/"</span>)     <span class="comment">// 这里baseUrl是所有api的基础url，必须配置</span></div><div class="line">              .addConverterFactory(GsonConverterFactory.create())   <span class="comment">//这里是将返回的json转成一个定义好的java对象。</span></div><div class="line">              .build();</div></pre></td></tr></table></figure>
<ul>
<li>接下来定义一个NewsInfo实体类，实体类的字段是和json对应的，代码如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewsInfo</span></span>&#123;</div><div class="line">    <span class="keyword">public</span> String title;</div><div class="line">    <span class="keyword">public</span> String detailInfo;</div><div class="line">    <span class="comment">// 我这里就是举个例子，重点是分析Retrofit源码。</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>最后就是使用，非常简洁，代码如下：<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">APIService service = retrofit.create(APIService.class);</div><div class="line">Call&lt;NewsInfo&gt; call = service.getNews(<span class="string">"10"</span>);</div><div class="line">call.enqueue(<span class="keyword">new</span> Callback&lt;NewsInfo&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call&lt;NewsInfo&gt; call,</span></span></div><div class="line">                           Response&lt;NewsInfo&gt; response) &#123;</div><div class="line">        Log.i(TAG, <span class="string">"onResponse"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call&lt;NewsInfo&gt; call, Throwable t)</span> </span>&#123;</div><div class="line">        Log.i(TAG, <span class="string">"onFailure"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><ul>
<li>Retrofit的一大优点是解耦，其中牵扯到很多设计模式，下面会提到。<h3 id="首先构造Retrofit对象："><a href="#首先构造Retrofit对象：" class="headerlink" title="首先构造Retrofit对象："></a>首先构造Retrofit对象：</h3></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Retrofit retrofit =<span class="keyword">new</span> Retrofit.Builder()</div><div class="line">              .baseUrl(<span class="string">"http://hcy.com/api/"</span>)     <span class="comment">// 这里baseUrl是所有api的基础url，必须配置</span></div><div class="line">              .addConverterFactory(GsonConverterFactory.create())   <span class="comment">//这里是将返回的json转成一个定义好的java对象。</span></div><div class="line">              .build();</div></pre></td></tr></table></figure>
<ul>
<li>这使用到了常见的构造者模式，我们来看builder()做了什么：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">this</span>(Platform.get());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**接下来看Platform主要做了什么，其实就是findPlatform,用来查找当前的平台是啥：android？java？ios？</span></div><div class="line">*/</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Platform PLATFORM = findPlatform();</div><div class="line"><span class="function"><span class="keyword">static</span> Platform <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> PLATFORM;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Platform <span class="title">findPlatform</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">      Class.forName(<span class="string">"android.os.Build"</span>);</div><div class="line">      <span class="keyword">if</span> (Build.VERSION.SDK_INT != <span class="number">0</span>) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Android();</div><div class="line">    &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException ignored) &#123;</div><div class="line">    &#125;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">      Class.forName(<span class="string">"java.util.Optional"</span>);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Java8();</div><div class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException ignored) &#123;</div><div class="line">    &#125;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">      Class.forName(<span class="string">"org.robovm.apple.foundation.NSObject"</span>);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> IOS();</div><div class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException ignored) &#123;</div><div class="line">    &#125;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Platform();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**接下来是Android类， 它继承了Platform重写了defaultCallbackExecutor和defaultCallAdapterFactory方法。</span></div><div class="line">//defaultCallbackExecutor：返回的是用于执行 Callback 的 线程池。可以看到MainThreadExecutor 获取了主线程的 Looper 并构造了一个主线程的 Handler，调用 Callback 时会将该请求 post 到主线程上去执行。这就解释了为什么请求后完成的回调都是在主线中。</div><div class="line">// defaultCallAdapterFactory：将返回的适配类型默认为Call类型（如果使用RxJava的话，就可以通过配置.addCallAdapterFactory(RxJavaCallAdapterFactory.create())将配置类型改成Observable。）</div><div class="line">*/</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Android</span> <span class="keyword">extends</span> <span class="title">Platform</span> </span>&#123;</div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Executor <span class="title">defaultCallbackExecutor</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MainThreadExecutor();</div><div class="line">  &#125;</div><div class="line">  <span class="meta">@Override</span> CallAdapter.<span class="function">Factory <span class="title">defaultCallAdapterFactory</span><span class="params">(Executor callbackExecutor)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ExecutorCallAdapterFactory(callbackExecutor);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MainThreadExecutor</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Handler handler = <span class="keyword">new</span> Handler(Looper.getMainLooper());</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line">      handler.post(r);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>再看baseUrl()的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 通过下面的代码，可以看出其实它拿到baseUrl主要创建了okhttp的HttpUrl。</span></div><div class="line"><span class="function"><span class="keyword">public</span> Builder <span class="title">baseUrl</span><span class="params">(String baseUrl)</span> </span>&#123;</div><div class="line">checkNotNull(baseUrl, <span class="string">"baseUrl == null"</span>);</div><div class="line">HttpUrl httpUrl = HttpUrl.parse(baseUrl);</div><div class="line"><span class="keyword">if</span> (httpUrl == <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal URL: "</span> + baseUrl);</div><div class="line">&#125;</div><div class="line"><span class="keyword">return</span> baseUrl(httpUrl);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">public</span> Builder <span class="title">baseUrl</span><span class="params">(HttpUrl baseUrl)</span> </span>&#123;</div><div class="line">checkNotNull(baseUrl, <span class="string">"baseUrl == null"</span>);</div><div class="line">List&lt;String&gt; pathSegments = baseUrl.pathSegments();</div><div class="line"><span class="keyword">if</span> (!<span class="string">""</span>.equals(pathSegments.get(pathSegments.size() - <span class="number">1</span>))) &#123;</div><div class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"baseUrl must end in /: "</span> + baseUrl);</div><div class="line">&#125;</div><div class="line"><span class="keyword">this</span>.baseUrl = baseUrl;</div><div class="line"><span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>再看addConverterFactory(GsonConverterFactory.create())：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 往转换工厂集合中添加了我们指定的转换工厂.在我们的例子里面 GsonConverterFactory 将选用 GsonConverter 来转换。</span></div><div class="line"><span class="function"><span class="keyword">public</span> Builder <span class="title">addConverterFactory</span><span class="params">(Converter.Factory factory)</span> </span>&#123;</div><div class="line">  converterFactories.add(checkNotNull(factory, <span class="string">"factory == null"</span>));</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>接下来是build的过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Retrofit <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (baseUrl == <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Base URL required."</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  okhttp3.Call.Factory callFactory = <span class="keyword">this</span>.callFactory;</div><div class="line">  <span class="keyword">if</span> (callFactory == <span class="keyword">null</span>) &#123;</div><div class="line">    callFactory = <span class="keyword">new</span> OkHttpClient();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  Executor callbackExecutor = <span class="keyword">this</span>.callbackExecutor;</div><div class="line">  <span class="keyword">if</span> (callbackExecutor == <span class="keyword">null</span>) &#123;</div><div class="line">    callbackExecutor = platform.defaultCallbackExecutor();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Make a defensive copy of the adapters and add the default Call adapter.</span></div><div class="line">  List&lt;CallAdapter.Factory&gt; adapterFactories = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.adapterFactories);</div><div class="line">  adapterFactories.add(platform.defaultCallAdapterFactory(callbackExecutor));</div><div class="line"></div><div class="line">  <span class="comment">// Make a defensive copy of the converters.</span></div><div class="line">  List&lt;Converter.Factory&gt; converterFactories = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.converterFactories);</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Retrofit(callFactory, baseUrl, converterFactories, adapterFactories,</div><div class="line">      callbackExecutor, validateEagerly);</div><div class="line">&#125;</div><div class="line"><span class="comment">// 这就是创建Retorfit对象的地方，将前面几步配置的参数都设置到Retrofit中，这里可以很明确的看到默认callFactory用的是OKHttpClient</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="创建接口实例并调用"><a href="#创建接口实例并调用" class="headerlink" title="创建接口实例并调用"></a>创建接口实例并调用</h3><ul>
<li><p>对应上面的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">APIService service = retrofit.create(APIService.class);</div><div class="line">Call&lt;NewsInfo&gt; call = service.getNews(<span class="string">"10"</span>);</div></pre></td></tr></table></figure>
</li>
<li><p>我们先看一下create的代码,它主要做了什么我都写到注释中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; service)</span> </span>&#123;</div><div class="line">    <span class="comment">// 检查service是否是个接口</span></div><div class="line">    Utils.validateServiceInterface(service);</div><div class="line">    <span class="comment">// 检查是否要提前创建serviceMethod</span></div><div class="line">    <span class="keyword">if</span> (validateEagerly) &#123;</div><div class="line">      eagerlyValidateMethods(service);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 这里就是设计非常巧妙的地方了，用到了java动态代理，我会在另外一篇文章中讲动态代理</span></div><div class="line">    <span class="comment">// 这里返回的是一个动态代理，然后又转成了对应的接口类型</span></div><div class="line">    <span class="keyword">return</span> (T) Proxy.newProxyInstance(service.getClassLoader(), <span class="keyword">new</span> Class&lt;?&gt;[] &#123; service &#125;,</div><div class="line">        <span class="keyword">new</span> InvocationHandler() &#123;</div><div class="line">          <span class="keyword">private</span> <span class="keyword">final</span> Platform platform = Platform.get();</div><div class="line"></div><div class="line">          <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span></div><div class="line">              <span class="keyword">throws</span> Throwable &#123;</div><div class="line">            <span class="comment">// If the method is a method from Object then defer to normal invocation.</span></div><div class="line">            <span class="comment">// 判断是会否为object方法，是的话就直接调用</span></div><div class="line">            <span class="keyword">if</span> (method.getDeclaringClass() == Object.class) &#123;</div><div class="line">              <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// 这里现在默认是直接返回false的。</span></div><div class="line">            <span class="keyword">if</span> (platform.isDefaultMethod(method)) &#123;</div><div class="line">              <span class="keyword">return</span> platform.invokeDefaultMethod(method, service, proxy, args);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// 接下来主要做了以下事情：</span></div><div class="line">            <span class="comment">// 1. 去serviceMethodCache，查是否有对应serviceMethod的缓存。执行完一遍会缓存下来。</span></div><div class="line">            <span class="comment">// 2. 如果不存在缓存就去创建一个。</span></div><div class="line">            <span class="comment">//</span></div><div class="line">            ServiceMethod&lt;Object, Object&gt; serviceMethod =</div><div class="line">                (ServiceMethod&lt;Object, Object&gt;) loadServiceMethod(method);</div><div class="line">            OkHttpCall&lt;Object&gt; okHttpCall = <span class="keyword">new</span> OkHttpCall&lt;&gt;(serviceMethod, args);</div><div class="line">            <span class="keyword">return</span> serviceMethod.callAdapter.adapt(okHttpCall);</div><div class="line">          &#125;</div><div class="line">        &#125;);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>接下来我们看下ServiceMethod的build过程：</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> ServiceMethod <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="comment">// callAdapter 是从CallAdapterFactory中选择合适的callAdapter</span></div><div class="line">      callAdapter = createCallAdapter();</div><div class="line">      <span class="comment">// 获取返回类型</span></div><div class="line">      responseType = callAdapter.responseType();</div><div class="line">      <span class="keyword">if</span> (responseType == Response.class || responseType == okhttp3.Response.class) &#123;</div><div class="line">        <span class="keyword">throw</span> methodError(<span class="string">"'"</span></div><div class="line">            + Utils.getRawType(responseType).getName()</div><div class="line">            + <span class="string">"' is not a valid response body type. Did you mean ResponseBody?"</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 去获取一个合适的responseConverter，我们例子中用到的是GsonConverter</span></div><div class="line">      responseConverter = createResponseConverter();</div><div class="line"></div><div class="line">      <span class="comment">// 解析各种注解。比如GET POST、PATCH、DELETE等等</span></div><div class="line">      <span class="keyword">for</span> (Annotation annotation : methodAnnotations) &#123;</div><div class="line">        parseMethodAnnotation(annotation);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (httpMethod == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> methodError(<span class="string">"HTTP method annotation is required (e.g., @GET, @POST, etc.)."</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (!hasBody) &#123;</div><div class="line">        <span class="keyword">if</span> (isMultipart) &#123;</div><div class="line">          <span class="keyword">throw</span> methodError(</div><div class="line">              <span class="string">"Multipart can only be specified on HTTP methods with request body (e.g., @POST)."</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (isFormEncoded) &#123;</div><div class="line">          <span class="keyword">throw</span> methodError(<span class="string">"FormUrlEncoded can only be specified on HTTP methods with "</span></div><div class="line">              + <span class="string">"request body (e.g., @POST)."</span>);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// parameterAnnotationsArray是method.getParameterAnnotations() 获取的是方法的参数和参数的注解</span></div><div class="line">      <span class="comment">// 比如本例中@Query("limit") String limit</span></div><div class="line">      <span class="keyword">int</span> parameterCount = parameterAnnotationsArray.length;</div><div class="line">      parameterHandlers = <span class="keyword">new</span> ParameterHandler&lt;?&gt;[parameterCount];</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; parameterCount; p++) &#123;</div><div class="line">        Type parameterType = parameterTypes[p];</div><div class="line">        <span class="keyword">if</span> (Utils.hasUnresolvableType(parameterType)) &#123;</div><div class="line">          <span class="keyword">throw</span> parameterError(p, <span class="string">"Parameter type must not include a type variable or wildcard: %s"</span>,</div><div class="line">              parameterType);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Annotation[] parameterAnnotations = parameterAnnotationsArray[p];</div><div class="line">        <span class="keyword">if</span> (parameterAnnotations == <span class="keyword">null</span>) &#123;</div><div class="line">          <span class="keyword">throw</span> parameterError(p, <span class="string">"No Retrofit annotation found."</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 将处理过后的parameterHandler放到parameterHandlers中</span></div><div class="line">        parameterHandlers[p] = parseParameter(p, parameterType, parameterAnnotations);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (relativeUrl == <span class="keyword">null</span> &amp;&amp; !gotUrl) &#123;</div><div class="line">        <span class="keyword">throw</span> methodError(<span class="string">"Missing either @%s URL or @Url parameter."</span>, httpMethod);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (!isFormEncoded &amp;&amp; !isMultipart &amp;&amp; !hasBody &amp;&amp; gotBody) &#123;</div><div class="line">        <span class="keyword">throw</span> methodError(<span class="string">"Non-body HTTP method cannot contain @Body."</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (isFormEncoded &amp;&amp; !gotField) &#123;</div><div class="line">        <span class="keyword">throw</span> methodError(<span class="string">"Form-encoded method must contain at least one @Field."</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (isMultipart &amp;&amp; !gotPart) &#123;</div><div class="line">        <span class="keyword">throw</span> methodError(<span class="string">"Multipart method must contain at least one @Part."</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// 创建一个ServiceMethod对象，里面包含了所有的网络请求及返回结果处理相关的数据：</span></div><div class="line">      <span class="comment">/**</span></div><div class="line">    this.callFactory = builder.retrofit.callFactory();</div><div class="line">    this.callAdapter = builder.callAdapter;</div><div class="line">    this.baseUrl = builder.retrofit.baseUrl();</div><div class="line">    this.responseConverter = builder.responseConverter;</div><div class="line">    this.httpMethod = builder.httpMethod;</div><div class="line">    this.relativeUrl = builder.relativeUrl;</div><div class="line">    this.headers = builder.headers;</div><div class="line">    this.contentType = builder.contentType;</div><div class="line">    this.hasBody = builder.hasBody;</div><div class="line">    this.isFormEncoded = builder.isFormEncoded;</div><div class="line">    this.isMultipart = builder.isMultipart;</div><div class="line">    this.parameterHandlers = builder.parameterHandlers;</div><div class="line">    */</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ServiceMethod&lt;&gt;(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 由上可知，ServiceMethod其实就是一个控制器一样的东西，处理网络请求。</span></div></pre></td></tr></table></figure>
<ul>
<li>接下来就是创建一个OKHttpCall</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">OkHttpCall&lt;Object&gt; okHttpCall = <span class="keyword">new</span> OkHttpCall&lt;&gt;(serviceMethod, args);</div><div class="line"><span class="comment">// 我们看下OKHttpCall是个什么鬼东西</span></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OkHttpCall</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Call</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ServiceMethod&lt;T, ?&gt; serviceMethod;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Object[] args;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> canceled;</div><div class="line"></div><div class="line">  <span class="comment">// All guarded by this.</span></div><div class="line">  <span class="comment">// 我们看到底层用到了okhttp3</span></div><div class="line">  <span class="keyword">private</span> okhttp3.Call rawCall;</div><div class="line">  <span class="keyword">private</span> Throwable creationFailure; <span class="comment">// Either a RuntimeException or IOException.</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> executed;</div><div class="line"></div><div class="line">  OkHttpCall(ServiceMethod&lt;T, ?&gt; serviceMethod, Object[] args) &#123;</div><div class="line">    <span class="keyword">this</span>.serviceMethod = serviceMethod;</div><div class="line">    <span class="keyword">this</span>.args = args;</div><div class="line">  &#125;</div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Request <span class="title">request</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(<span class="keyword">final</span> Callback&lt;T&gt; callback)</span> </span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>接下来就是返回处理</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">serviceMethod.callAdapter.adapt(okHttpCall);</div><div class="line"></div><div class="line"><span class="comment">// 这里的逻辑，要跟踪到创建retrofit对象的代码中</span></div><div class="line"><span class="comment">// Make a defensive copy of the adapters and add the default Call adapter.  Retrofit.java</span></div><div class="line">Executor callbackExecutor = <span class="keyword">this</span>.callbackExecutor;</div><div class="line"><span class="keyword">if</span> (callbackExecutor == <span class="keyword">null</span>) &#123;</div><div class="line">  callbackExecutor = platform.defaultCallbackExecutor();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Make a defensive copy of the adapters and add the default Call adapter.</span></div><div class="line">List&lt;CallAdapter.Factory&gt; adapterFactories = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.adapterFactories);</div><div class="line">adapterFactories.add(platform.defaultCallAdapterFactory(callbackExecutor));</div><div class="line"><span class="comment">// 继续跟踪代码，最后会进入到ExecutorCallAdapterFactory中，这是库默认的一个CallAdapter。</span></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorCallAdapterFactory</span> <span class="keyword">extends</span> <span class="title">CallAdapter</span>.<span class="title">Factory</span> </span>&#123;</div><div class="line">  <span class="keyword">final</span> Executor callbackExecutor;</div><div class="line"></div><div class="line">  ExecutorCallAdapterFactory(Executor callbackExecutor) &#123;</div><div class="line">    <span class="keyword">this</span>.callbackExecutor = callbackExecutor;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="keyword">public</span> CallAdapter&lt;?, ?&gt; get(Type returnType, Annotation[] annotations, Retrofit retrofit) &#123;</div><div class="line">    <span class="keyword">if</span> (getRawType(returnType) != Call.class) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">final</span> Type responseType = Utils.getCallResponseType(returnType);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CallAdapter&lt;Object, Call&lt;?&gt;&gt;() &#123;</div><div class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Type <span class="title">responseType</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> responseType;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 因此serviceMethod.callAdapter.adapt(okHttpCall)最后返回的是一个ExecutorCallbackCall，这里用到了适配器模式</span></div><div class="line">      <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Call&lt;Object&gt; <span class="title">adapt</span><span class="params">(Call&lt;Object&gt; call)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ExecutorCallbackCall&lt;&gt;(callbackExecutor, call);</div><div class="line">      &#125;</div><div class="line">    &#125;;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h3 id="发起请求"><a href="#发起请求" class="headerlink" title="发起请求"></a>发起请求</h3><ul>
<li><p>上一步提到，当执行定义的service方法，本例中是getNews，会返回一个ExecutorCallbackCall，我们接下来看下这个类的结构：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorCallbackCall</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Call</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">final</span> Executor callbackExecutor;</div><div class="line">    <span class="keyword">final</span> Call&lt;T&gt; delegate;</div><div class="line"></div><div class="line">    ExecutorCallbackCall(Executor callbackExecutor, Call&lt;T&gt; delegate) &#123;</div><div class="line">      <span class="keyword">this</span>.callbackExecutor = callbackExecutor;</div><div class="line">      <span class="keyword">this</span>.delegate = delegate;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(<span class="keyword">final</span> Callback&lt;T&gt; callback)</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (callback == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"callback == null"</span>);</div><div class="line"></div><div class="line">      delegate.enqueue(<span class="keyword">new</span> Callback&lt;T&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call&lt;T&gt; call, <span class="keyword">final</span> Response&lt;T&gt; response)</span> </span>&#123;</div><div class="line">          callbackExecutor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">              <span class="keyword">if</span> (delegate.isCanceled()) &#123;</div><div class="line">                <span class="comment">// Emulate OkHttp's behavior of throwing/delivering an IOException on cancellation.</span></div><div class="line">                callback.onFailure(ExecutorCallbackCall.<span class="keyword">this</span>, <span class="keyword">new</span> IOException(<span class="string">"Canceled"</span>));</div><div class="line">              &#125; <span class="keyword">else</span> &#123;</div><div class="line">                callback.onResponse(ExecutorCallbackCall.<span class="keyword">this</span>, response);</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call&lt;T&gt; call, <span class="keyword">final</span> Throwable t)</span> </span>&#123;</div><div class="line">          callbackExecutor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">              callback.onFailure(ExecutorCallbackCall.<span class="keyword">this</span>, t);</div><div class="line">            &#125;</div><div class="line">          &#125;);</div><div class="line">        &#125;</div><div class="line">      &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isExecuted</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> delegate.isExecuted();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Response&lt;T&gt; <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">      <span class="keyword">return</span> delegate.execute();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</div><div class="line">      delegate.cancel();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCanceled</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> delegate.isCanceled();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"CloneDoesntCallSuperClone"</span>) <span class="comment">// Performing deep clone.</span></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Call&lt;T&gt; <span class="title">clone</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ExecutorCallbackCall&lt;&gt;(callbackExecutor, delegate.clone());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Request <span class="title">request</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> delegate.request();</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>类里面有两个关键方法：enqueue（用于异步执行网络请求）、request（用于同步执行网络请求）。</p>
</li>
<li>enqueue方法，是callbackExecutor.execute(Runnable),这又得联想到刚才构建Android platform时创建了一个defaultCallbackExecutor，将runnable post到主线程。</li>
<li>再结合上面写的例子，相信你已经大致了解执行过程了。</li>
</ul>
<h3 id="将返回结果转成我们需要的类型"><a href="#将返回结果转成我们需要的类型" class="headerlink" title="将返回结果转成我们需要的类型"></a>将返回结果转成我们需要的类型</h3><ul>
<li>最后补上一个点，怎么转换类型，例子中我们用的是Gson，所以我就结合着代码说一下它是怎么转换的。首先我们在构造Retrofit时传入了一个 GsonConverterFactory.create()。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * Create an instance using &#123;<span class="doctag">@code</span> gson&#125; for conversion. Encoding to JSON and</div><div class="line">  * decoding from JSON (when no charset is specified by a header) will use UTF-8.</div><div class="line">  */</div><div class="line">  <span class="comment">//  它最终会创建一个GsonConverterFactory</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GsonConverterFactory <span class="title">create</span><span class="params">(Gson gson)</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> GsonConverterFactory(gson);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<ul>
<li>在GsonConvertFactory中有两个非常重要的方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">*  创建一个返回结果的Converter</div><div class="line">*/</div><div class="line"><span class="meta">@Override</span></div><div class="line">  <span class="keyword">public</span> Converter&lt;ResponseBody, ?&gt; responseBodyConverter(Type type, Annotation[] annotations,</div><div class="line">      Retrofit retrofit) &#123;</div><div class="line">    TypeAdapter&lt;?&gt; adapter = gson.getAdapter(TypeToken.get(type));</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> GsonResponseBodyConverter&lt;&gt;(gson, adapter);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="keyword">public</span> Converter&lt;?, RequestBody&gt; requestBodyConverter(Type type,</div><div class="line">      Annotation[] parameterAnnotations, Annotation[] methodAnnotations, Retrofit retrofit) &#123;</div><div class="line">    TypeAdapter&lt;?&gt; adapter = gson.getAdapter(TypeToken.get(type));</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> GsonRequestBodyConverter&lt;&gt;(gson, adapter);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<ul>
<li>上面提到的网络请求，最终会由okhttp执行，最后拿到回调结果后，会执行到ServiceMethod中：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Builds a method return value from an HTTP response body. */</span></div><div class="line"><span class="comment">/**</span></div><div class="line">  这里的responseConverter就是上面创建的GsonRequestBodyConverter</div><div class="line">*/</div><div class="line"> <span class="function">R <span class="title">toResponse</span><span class="params">(ResponseBody body)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">   <span class="keyword">return</span> responseConverter.convert(body);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<ul>
<li>我们来看看GsonRequestBodyConverter的convert方法都做了什么</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  它主要就是调用Gson的接口，将json转成了对应的对象。</div><div class="line">  这里的adapter 是这么得来的  TypeAdapter&lt;?&gt; adapter = gson.getAdapter(TypeToken.get(type)); 也就是得到返回类的adapter</div><div class="line">*/</div><div class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> T <span class="title">convert</span><span class="params">(ResponseBody value)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    JsonReader jsonReader = gson.newJsonReader(value.charStream());</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">return</span> adapter.read(jsonReader);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      value.close();</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<ul>
<li>最后回调给Callback的onSuccess或者onFailure。</li>
<li>中间略去一些过程，我觉得结合代码是比较容易理解的，我这里就列出一个大致的流程思路。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>Retrofit的设计非常巧妙，将各个模块都解耦，可以根据自己的需要来组装。因此不得不对大牛的设计感到惊叹。</li>
<li>第一次看可能会看的有点迷糊，建议结合源码多次看。相信每次的收获都会不同吧。</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Liwei" />
          <p class="site-author-name" itemprop="name">Liwei</p>
           
              <p class="site-description motion-element" itemprop="description">平时工作和生活中的感悟记录</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">27</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">27</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Liwei</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"xdjatester"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  
















  





  

  

  

  

</body>
</html>
